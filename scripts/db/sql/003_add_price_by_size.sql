-- =============================================================================
-- МІГРАЦІЯ: Додати price_by_size JSONB для варіативних цін
-- =============================================================================
-- 
-- ПРОБЛЕМА: 
--   В колонці price зберігається ОДНЕ значення (1590.00), хоча реальна ціна
--   залежить від розміру (1590-2390 грн).
--   Це призводить до неправильних цін при продажу!
--
-- РІШЕННЯ:
--   Додати колонку price_by_size типу JSONB:
--   {"80-92": 1590, "98-104": 1790, "110-116": 1990, ...}
--
-- СУМІСНІСТЬ:
--   CatalogService.get_price_for_size() вже підтримує цю колонку!
--   Якщо price_by_size є - бере звідти, інакше fallback на price.
-- =============================================================================

-- КРОК 1: Додати колонку (якщо не існує)
ALTER TABLE products 
ADD COLUMN IF NOT EXISTS price_by_size JSONB DEFAULT NULL;

-- Коментар для документації
COMMENT ON COLUMN products.price_by_size IS 
  'Ціни по розмірах. Формат: {"80-92": 1590, "98-104": 1790, ...}. NULL = єдина ціна в колонці price.';

-- КРОК 2: Оновити Костюми Лагуна (4 кольори)
-- Ціни: 80-92=1590, 98-104=1790, 110-116=1990, 122-128=2190, 134-140=2290, 146-152=2390, 158-164=2390
UPDATE products 
SET price_by_size = '{
  "80-92": 1590,
  "98-104": 1790,
  "110-116": 1990,
  "122-128": 2190,
  "134-140": 2290,
  "146-152": 2390,
  "158-164": 2390
}'::jsonb
WHERE name LIKE 'Костюм Лагуна%';

-- КРОК 3: Оновити Костюми Мрія (4 кольори)
-- Ціни: такі ж як Лагуна
UPDATE products 
SET price_by_size = '{
  "80-92": 1590,
  "98-104": 1790,
  "110-116": 1990,
  "122-128": 2190,
  "134-140": 2290,
  "146-152": 2390,
  "158-164": 2390
}'::jsonb
WHERE name LIKE 'Костюм Мрія%';

-- КРОК 4: Оновити Костюм Мерея (1 колір)
-- Ціни: 80-92 до 122-128 = 1985, 134-140 до 158-164 = 2150
UPDATE products 
SET price_by_size = '{
  "80-92": 1985,
  "98-104": 1985,
  "110-116": 1985,
  "122-128": 1985,
  "134-140": 2150,
  "146-152": 2150,
  "158-164": 2150
}'::jsonb
WHERE name LIKE 'Костюм Мерея%';

-- КРОК 5: Перевірка (виконати окремо для перевірки)
-- SELECT name, price, price_by_size FROM products WHERE price_by_size IS NOT NULL;

-- =============================================================================
-- ГОТОВО! Тепер CatalogService.get_price_for_size() працюватиме правильно:
--   - get_price_for_size(product, "122-128") → 2190
--   - get_price_for_size(product, None) → 1590 (мін ціна)
--   - format_price_display(product) → "від 1590 до 2390 грн (залежить від розміру)"
-- =============================================================================
