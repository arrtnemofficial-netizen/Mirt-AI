# SQL Ð¡ÐºÑ€Ð¸Ð¿Ñ‚Ð¸ Ð´Ð»Ñ Followups & Summarization

## ðŸ“‹ ÐžÐ³Ð»ÑÐ´

Ð¦Ñ– ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¸ Ð´Ð¾Ð¿Ð¾Ð¼Ð¾Ð¶ÑƒÑ‚ÑŒ Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€Ð¸Ñ‚Ð¸ Ñ‚Ð° Ð²Ð¸Ð¿Ñ€Ð°Ð²Ð¸Ñ‚Ð¸ Ð‘Ð” Ð´Ð»Ñ Ñ€Ð¾Ð±Ð¾Ñ‚Ð¸ followups Ñ‚Ð° summarization worker'Ñ–Ð².

## ðŸš€ Ð¯Ðº Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÐ²Ð°Ñ‚Ð¸

### 1. ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ñ‚Ð° Ð²Ð¸Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸

**Ð¤Ð°Ð¹Ð»:** `check_and_fix_followups_summarization.sql`

**Ð©Ð¾ Ñ€Ð¾Ð±Ð¸Ñ‚ÑŒ:**
- âœ… ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ” Ð½Ð°ÑÐ²Ð½Ñ–ÑÑ‚ÑŒ Ð¿Ð¾Ð»Ñ–Ð² Ð² Ñ‚Ð°Ð±Ð»Ð¸Ñ†ÑÑ… `users` Ñ‚Ð° `messages`
- âœ… Ð¡Ñ‚Ð²Ð¾Ñ€ÑŽÑ” Ð²Ñ–Ð´ÑÑƒÑ‚Ð½Ñ– Ð¿Ð¾Ð»Ñ Ñ‚Ð° Ñ–Ð½Ð´ÐµÐºÑÐ¸
- âœ… ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ” Ñ„ÑƒÐ½ÐºÑ†Ñ–ÑŽ `summarize_inactive_users`
- âœ… Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ñ–Ð·ÑƒÑ” `last_interaction_at` Ð· messages
- âœ… ÐŸÐ¾ÐºÐ°Ð·ÑƒÑ” ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ Ð´Ð°Ð½Ð¸Ñ…

**Ð¯Ðº Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ð¸:**
```sql
-- Ð’ Supabase SQL Editor Ð°Ð±Ð¾ psql
\i scripts/sql/check_and_fix_followups_summarization.sql
```

**Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚:** Ð’Ð¸Ð²ÐµÐ´Ðµ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¸Ð¹ Ð·Ð²Ñ–Ñ‚ Ð¿Ñ€Ð¾ ÑÑ‚Ð°Ð½ Ð‘Ð” Ñ‚Ð° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð¾ Ð²Ð¸Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð¸.

---

### 2. Ð¢ÐµÑÑ‚Ð¾Ð²Ñ– Ð·Ð°Ð¿Ð¸Ñ‚Ð¸

**Ð¤Ð°Ð¹Ð»:** `test_followups_summarization.sql`

**Ð©Ð¾ Ñ€Ð¾Ð±Ð¸Ñ‚ÑŒ:**
- ðŸ” ÐŸÐ¾ÐºÐ°Ð·ÑƒÑ” ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ñ–Ð², ÑÐºÑ– Ð¿Ð¾Ñ‚Ñ€ÐµÐ±ÑƒÑŽÑ‚ÑŒ summarization
- ðŸ” ÐŸÐ¾ÐºÐ°Ð·ÑƒÑ” ÑÐµÑÑ–Ñ—, ÑÐºÑ– Ð¿Ð¾Ñ‚Ñ€ÐµÐ±ÑƒÑŽÑ‚ÑŒ followups
- ðŸ” ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ” Ð·Ð²'ÑÐ·ÐºÐ¸ Ð¼Ñ–Ð¶ Ñ‚Ð°Ð±Ð»Ð¸Ñ†ÑÐ¼Ð¸
- ðŸ” Ð”Ñ–Ð°Ð³Ð½Ð¾ÑÑ‚ÑƒÑ” Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð¸

**Ð¯Ðº Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ð¸:**
```sql
-- Ð—Ð°Ð¿ÑƒÑÐºÐ°Ð¹ Ð¾ÐºÑ€ÐµÐ¼Ñ– Ð·Ð°Ð¿Ð¸Ñ‚Ð¸ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ¸
-- ÐÐ°Ð¿Ñ€Ð¸ÐºÐ»Ð°Ð´:
SELECT * FROM summarize_inactive_users();
```

**ÐšÐ¾Ñ€Ð¸ÑÐ½Ð¾ Ð´Ð»Ñ:**
- ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ¸ Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼ worker'Ñ–Ð²
- Ð”Ñ–Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ¸ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼
- ÐœÐ¾Ð½Ñ–Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ñƒ ÑÑ‚Ð°Ð½Ñƒ Ð´Ð°Ð½Ð¸Ñ…

---

### 3. Ð’Ð¸Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ñ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼ Ð· Ð´Ð°Ð½Ð¸Ð¼Ð¸

**Ð¤Ð°Ð¹Ð»:** `fix_data_issues.sql`

**Ð©Ð¾ Ñ€Ð¾Ð±Ð¸Ñ‚ÑŒ:**
- ðŸ”§ Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ñ–Ð·ÑƒÑ” `last_interaction_at` Ð· messages
- ðŸ”§ Ð—Ð°Ð¿Ð¾Ð²Ð½ÑŽÑ” `user_id` Ð² messages
- ðŸ”§ Ð†Ð½Ñ–Ñ†Ñ–Ð°Ð»Ñ–Ð·ÑƒÑ” `tags` Ð´Ð»Ñ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ñ–Ð²
- ðŸ”§ Ð’Ð¸Ð´Ð°Ð»ÑÑ” Ð´ÑƒÐ±Ð»Ñ–ÐºÐ°Ñ‚Ð¸ Ñ‚ÐµÐ³Ñ–Ð²
- ðŸ”§ Ð¡Ñ‚Ð²Ð¾Ñ€ÑŽÑ” users Ð´Ð»Ñ messages Ð±ÐµÐ· user_id

**Ð¯Ðº Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ð¸:**
```sql
-- Ð’ÐÐ–Ð›Ð˜Ð’Ðž: Ð—Ð°Ð¿ÑƒÑÐºÐ°Ð¹ Ñ‚Ñ–Ð»ÑŒÐºÐ¸ Ð¿Ñ–ÑÐ»Ñ check_and_fix!
\i scripts/sql/fix_data_issues.sql
```

**Ð£Ð²Ð°Ð³Ð°:** Ð¦ÐµÐ¹ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð·Ð¼Ñ–Ð½ÑŽÑ” Ð´Ð°Ð½Ñ–! ÐšÑ€Ð°Ñ‰Ðµ ÑÐ¿Ð¾Ñ‡Ð°Ñ‚ÐºÑƒ Ð·Ñ€Ð¾Ð±Ð¸Ñ‚Ð¸ backup.

---

## ðŸ“Š Ð©Ð¾ Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ‚Ð¸

### ÐŸÑ–ÑÐ»Ñ Ð·Ð°Ð¿ÑƒÑÐºÑƒ `check_and_fix_followups_summarization.sql`:

1. âœ… Ð’ÑÑ– Ð¿Ð¾Ð»Ñ Ñ–ÑÐ½ÑƒÑŽÑ‚ÑŒ
2. âœ… Ð’ÑÑ– Ñ–Ð½Ð´ÐµÐºÑÐ¸ ÑÑ‚Ð²Ð¾Ñ€ÐµÐ½Ñ–
3. âœ… Ð¤ÑƒÐ½ÐºÑ†Ñ–Ñ `summarize_inactive_users` Ð¿Ñ€Ð°Ñ†ÑŽÑ”
4. âœ… Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð²Ð¸Ð³Ð»ÑÐ´Ð°Ñ” Ñ€Ð¾Ð·ÑƒÐ¼Ð½Ð¾

### ÐŸÑ–ÑÐ»Ñ Ð·Ð°Ð¿ÑƒÑÐºÑƒ `test_followups_summarization.sql`:

1. ÐšÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ñ– Ð· `needs_summary` Ñ‚ÐµÐ³Ð¾Ð¼
2. Ð¡ÐµÑÑ–Ñ— ÑÑ‚Ð°Ñ€ÑˆÐµ 24 Ð³Ð¾Ð´Ð¸Ð½ (Ð´Ð»Ñ followups)
3. Ð’Ñ–Ð´ÑÑƒÑ‚Ð½Ñ–ÑÑ‚ÑŒ orphaned messages

---

## ðŸ› Ð¢Ð¸Ð¿Ð¾Ð²Ñ– Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð¸ Ñ‚Ð° Ñ€Ñ–ÑˆÐµÐ½Ð½Ñ

### ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°: "users.user_id is NULL"
**Ð Ñ–ÑˆÐµÐ½Ð½Ñ:** Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸ `fix_data_issues.sql` (FIX 6)

### ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°: "last_interaction_at Ð½Ðµ Ð¾Ð½Ð¾Ð²Ð»ÑŽÑ”Ñ‚ÑŒÑÑ"
**Ð Ñ–ÑˆÐµÐ½Ð½Ñ:** Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸ `fix_data_issues.sql` (FIX 1)

### ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°: "messages Ð±ÐµÐ· user_id"
**Ð Ñ–ÑˆÐµÐ½Ð½Ñ:** Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸ `fix_data_issues.sql` (FIX 2, FIX 6)

### ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°: "summarize_inactive_users Ð½Ðµ Ð¿Ñ€Ð°Ñ†ÑŽÑ”"
**Ð Ñ–ÑˆÐµÐ½Ð½Ñ:** ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ Ñ‡ÐµÑ€ÐµÐ· `check_and_fix_followups_summarization.sql` (STEP 2)

---

## ðŸ”„ Ð ÐµÐ³ÑƒÐ»ÑÑ€Ð½Ðµ Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð°Ð½Ð½Ñ

### Ð©Ð¾Ð´Ð½Ñ:
```sql
-- ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸
SELECT COUNT(*) FROM users WHERE tags @> ARRAY['needs_summary']::TEXT[];
SELECT COUNT(*) FROM messages WHERE created_at < NOW() - INTERVAL '24 hours';
```

### Ð©Ð¾Ñ‚Ð¸Ð¶Ð½Ñ:
```sql
-- Ð—Ð°Ð¿ÑƒÑÐº Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ¸ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸
\i scripts/sql/check_and_fix_followups_summarization.sql
```

### ÐŸÑ€Ð¸ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð°Ñ…:
```sql
-- Ð¡Ð¿Ð¾Ñ‡Ð°Ñ‚ÐºÑƒ Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ°
\i scripts/sql/check_and_fix_followups_summarization.sql

-- ÐŸÐ¾Ñ‚Ñ–Ð¼ Ð²Ð¸Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ñ
\i scripts/sql/fix_data_issues.sql

-- ÐŸÐ¾Ñ‚Ñ–Ð¼ Ñ‚ÐµÑÑ‚Ð¸
\i scripts/sql/test_followups_summarization.sql
```

---

## ðŸ“ ÐÐ¾Ñ‚Ð°Ñ‚ÐºÐ¸

- Ð’ÑÑ– ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¸ Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑŽÑ‚ÑŒ `RAISE NOTICE` Ð´Ð»Ñ Ð²Ð¸Ð²Ð¾Ð´Ñƒ Ñ–Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–Ñ—
- Ð¡ÐºÑ€Ð¸Ð¿Ñ‚Ð¸ Ñ–Ð´ÐµÐ¼Ð¿Ð¾Ñ‚ÐµÐ½Ñ‚Ð½Ñ– (Ð¼Ð¾Ð¶Ð½Ð° Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚Ð¸ Ð±Ð°Ð³Ð°Ñ‚Ð¾ Ñ€Ð°Ð·Ñ–Ð²)
- Ð¡ÐºÑ€Ð¸Ð¿Ñ‚Ð¸ Ð½Ðµ Ð²Ð¸Ð´Ð°Ð»ÑÑŽÑ‚ÑŒ Ð´Ð°Ð½Ñ– (Ñ‚Ñ–Ð»ÑŒÐºÐ¸ Ð´Ð¾Ð´Ð°ÑŽÑ‚ÑŒ/Ð¾Ð½Ð¾Ð²Ð»ÑŽÑŽÑ‚ÑŒ)
- Ð”Ð»Ñ production ÐºÑ€Ð°Ñ‰Ðµ Ñ€Ð¾Ð±Ð¸Ñ‚Ð¸ backup Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼ `fix_data_issues.sql`

