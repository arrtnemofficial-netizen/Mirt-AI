# Mirt-AI

AI-—Å—Ç–∏–ª—ñ—Å—Ç –¥–ª—è –±—Ä–µ–Ω–¥—É –¥–∏—Ç—è—á–æ–≥–æ –æ–¥—è–≥—É MIRT. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î Grok 4.1 fast / GPT-5.1 / Gemini 3 Pro, Pydantic AI, LangGraph v2 —Ç–∞ Supabase.

[![Python 3.11+](https://img.shields.io/badge/python-3.11+-blue.svg)](https://www.python.org/downloads/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Tests](https://img.shields.io/badge/tests-50%20passed-brightgreen.svg)]()

## üèó –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ v2

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        FastAPI Server                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Telegram   ‚îÇ  ‚îÇ  ManyChat   ‚îÇ  ‚îÇ     Automation API      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  Webhook    ‚îÇ  ‚îÇ  Webhook    ‚îÇ  ‚îÇ  (summarize, followups) ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îÇ
‚îÇ                          ‚ñº                                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ                 LangGraph v2 (5 nodes)                     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                                             ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îÇmoderation‚îÇ ‚Üí ‚îÇtool_plan ‚îÇ ‚Üí ‚îÇ  agent   ‚îÇ               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                      ‚îÇ                      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ state_transition ‚îÇ ‚Üê ‚îÇ    validation      ‚îÇ            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                            ‚ñº                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ              Pydantic AI Agent (Grok/GPT/Gemini)          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - Supabase tools (search, get_by_id, get_by_photo)     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - LLM-specific prompts (data/prompts/)                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - Typed AgentResponse output                           ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### üéØ Key Design Decisions

| Decision | Implementation |
|----------|----------------|
| **FSM Source of Truth** | Code (`src/core/state_machine.py`), NOT prompt |
| **Tool Planning** | Pre-execution in code BEFORE LLM call |
| **Post-Validation** | Without LLM (price > 0, photo_url https://) |
| **Observability** | Structured logs with state/intent/latency tags |
| **LLM Switching** | Config-based (`LLM_PROVIDER=openrouter\|openai\|google`) |

### –ö–ª—é—á–æ–≤—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏

| –ú–æ–¥—É–ª—å | –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è |
|--------|-------------|
| `src/core/state_machine.py` | **FSM** ‚Äî State/Intent enums, transitions, keyboards |
| `src/core/models.py` | Pydantic schemas –∑ enum validators |
| `src/core/tool_planner.py` | Pre-LLM tool execution planning |
| `src/core/product_adapter.py` | Product validation (price > 0, https://) |
| `src/core/prompt_loader.py` | LLM-specific prompt loading |
| `src/agents/graph_v2.py` | **5-node LangGraph** orchestration |
| `src/services/observability.py` | Metrics + structured logging |
| `src/services/moderation.py` | PII detection, content filtering |

### ‚ö° Feature Flags

```env
USE_GRAPH_V2=true           # 5-node LangGraph (default: true)
USE_TOOL_PLANNER=true       # Pre-execute tools before LLM
USE_PRODUCT_VALIDATION=true # Validate products before send
USE_INPUT_VALIDATION=true   # Validate metadata enums
ENABLE_OBSERVABILITY=true   # Structured logs with tags
```

## –®–≤–∏–¥–∫–∏–π —Å—Ç–∞—Ä—Ç

### –í–∞—Ä—ñ–∞–Ω—Ç 1: Docker (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)

```bash
# –°–∫–æ–ø—ñ—é–π—Ç–µ .env.example —Ç–∞ –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è
cp .env.example .env

# –ó–∞–ø—É—Å—Ç—ñ—Ç—å
docker-compose up -d

# –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ health
curl http://localhost:8000/health
```

### –í–∞—Ä—ñ–∞–Ω—Ç 2: –õ–æ–∫–∞–ª—å–Ω–æ

```bash
# –°—Ç–≤–æ—Ä—ñ—Ç—å venv
python -m venv .venv
source .venv/bin/activate  # Linux/Mac
# .venv\Scripts\activate   # Windows

# –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
pip install -r requirements.txt

# –°–∫–æ–ø—ñ—é–π—Ç–µ —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–π—Ç–µ .env
cp .env.example .env

# –ó–∞–ø—É—Å—Ç—ñ—Ç—å —Å–µ—Ä–≤–µ—Ä
uvicorn src.server.main:app --reload
```

### –î–µ–º–æ-–≤–∏–∫–ª–∏–∫

```python
from src.agents.graph import app
from src.core import AgentState
import asyncio

state = {
    "messages": [{"role": "user", "content": "–ü—Ä–∏–≤—ñ—Ç! –ü–æ—Ç—Ä—ñ–±–Ω–∞ —á–µ—Ä–≤–æ–Ω–∞ —Å—É–∫–Ω—è 122 —Å–º."}],
    "metadata": {"session_id": "demo"},
    "current_state": AgentState.STATE1_DISCOVERY,
}

result = asyncio.run(app.ainvoke(state))
print(result)
```

## –¢–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç
- **–õ–æ–∫–∞–ª—å–Ω–æ (polling)**: `python -m src.bot.telegram_bot` –∞–±–æ –≤–∏–∫–ª–∏–∫ `run_polling()` —É –∫–æ–¥—ñ. –î–æ—Å—Ç–∞—Ç–Ω—å–æ –≤—Å—Ç–∞–≤–∏—Ç–∏ —Å–≤—ñ–π `TELEGRAM_BOT_TOKEN` —É `.env`.
- **Webhook**: –ø—ñ–¥–Ω—ñ–º—ñ—Ç—å FastAPI `uvicorn src.server.main:app --host 0.0.0.0 --port 8000`, –∑–∞–¥–∞–π—Ç–µ `PUBLIC_BASE_URL` (–ø—É–±–ª—ñ—á–Ω–∞ –∞–¥—Ä–µ—Å–∞ reverse-proxy/NGROK) ‚Äî –≤–µ–±—Ö—É–∫ —Ä–µ—î—Å—Ç—Ä—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –Ω–∞ —Å—Ç–∞—Ä—Ç—ñ.

## –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å–µ—Å—ñ–π, –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —ñ –∫–∞—Ç–∞–ª–æ–≥—É —É Supabase
- –°–µ—Å—ñ—ó: —Ç–∞–±–ª–∏—Ü—è `SUPABASE_TABLE` —ñ–∑ –ø–æ–ª—è–º–∏ `session_id` (PK, text) —ñ `state` (jsonb). –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –Ω–∞ Supabase –ø—Ä–∏ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ env.
- –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: —Ç–∞–±–ª–∏—Ü—è `SUPABASE_MESSAGES_TABLE` –∑ –ø–æ–ª—è–º–∏ `session_id`, `role`, `content`, `created_at` (timestamptz), `tags` (array/text[]). –£—Å—ñ –≤—Ö—ñ–¥–Ω—ñ —Ç–∞ –≤–∏—Ö—ñ–¥–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑–∞–ø–∏—Å—É—é—Ç—å—Å—è —Ç—É–¥–∏; —Ç–µ–≥ `humanNeeded-wd` —Å—Ç–∞–≤–∏—Ç—å—Å—è –Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –∑ –µ—Å–∫–∞–ª–∞—Ü—ñ—î—é.
- –ö–∞—Ç–∞–ª–æ–≥ (RAG): —Ç–∞–±–ª–∏—Ü—è `mirt_products` –∑ –ø–æ–ª—è–º–∏ –∑ system prompt (category/subcategory/sizes/material/price_uniform/price_by_size/colors). –ï–º–±–µ–¥–¥–∏–Ω–≥–∏ ‚Äî —Ç–∞–±–ª–∏—Ü—è `mirt_product_embeddings` (vector(1536)), RPC `match_mirt_products` –ø–æ–≤–µ—Ä—Ç–∞—î top-N. `data/catalog.json` —Ç–∞ `data/catalog.csv` —Å–ª—É–≥—É—é—Ç—å —î–¥–∏–Ω–∏–º –¥–∂–µ—Ä–µ–ª–æ–º –¥–ª—è —ñ–º–ø–æ—Ä—Ç—É.

## ManyChat / Instagram webhook
- –ï–Ω–¥–ø–æ—ñ–Ω—Ç: `POST /webhooks/manychat` –ø—Ä–∏–π–º–∞—î ManyChat payload (`subscriber.id`, `message.text`).
- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è: –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Manychat-Token` –º–∞—î –∑–±—ñ–≥–∞—Ç–∏—Å—è –∑ `MANYCHAT_VERIFY_TOKEN` —É `.env`.
- –í—ñ–¥–ø–æ–≤—ñ–¥—å: `{version:"v2", messages:[{type:"text",text:"..."},...], metadata:{current_state,...}}` ‚Äî —Å—É–º—ñ—Å–Ω–æ –∑ ManyChat reply API.

### –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—è –ø–µ—Ä–µ—É–ø–∞–∫–æ–≤–∫–∏
- –ï–Ω–¥–ø–æ—ñ–Ω—Ç: `POST /automation/mirt-summarize-prod-v1` –∑ —Ç—ñ–ª–æ–º `{ "session_id": "..." }`.
- –õ–æ–≥—ñ–∫–∞: —è–∫—â–æ –≤—ñ–¥ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –º–∏–Ω—É–ª–æ `SUMMARY_RETENTION_DAYS` –¥–Ω—ñ–≤ (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º 3), —É—Å—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø–æ `session_id` –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—é—Ç—å—Å—è —É —Å–∞–º–º–∞—Ä—ñ, –∑–∞–ø–∏—Å—É—é—Ç—å—Å—è —É –ø–æ–ª–µ `summary` —Ç–∞–±–ª–∏—Ü—ñ `SUPABASE_USERS_TABLE`, —Å—Ç–∞—Ä—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤–∏–¥–∞–ª—è—é—Ç—å—Å—è –∑ `SUPABASE_MESSAGES_TABLE`.
- –ü—Ä–∏ –ø–µ—Ä–µ—É–ø–∞–∫–æ–≤—Ü—ñ —Ç–µ–≥ `humanNeeded-wd` –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–Ω—ñ–º–∞—î—Ç—å—Å—è, —â–æ–± –∑–∞–∫—Ä–∏—Ç–∏ SLA –µ—Å–∫–∞–ª–∞—Ü—ñ—ó.

### –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—è —Ñ–æ–ª–æ—É–∞–ø—ñ–≤
- –ï–Ω–¥–ø–æ—ñ–Ω—Ç: `POST /automation/mirt-followups-prod-v1` –∑ —Ç—ñ–ª–æ–º `{ "session_id": "...", "schedule_hours": [24, 72] }`.
- –Ø–∫—â–æ `schedule_hours` –Ω–µ –∑–∞–¥–∞–Ω–∏–π, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è `FOLLOWUP_DELAYS_HOURS` –∑ `.env` (–∫–æ–º–∞-—Å–µ–ø–∞—Ä–æ–≤–∞–Ω–∏–π —Å–ø–∏—Å–æ–∫ –≥–æ–¥–∏–Ω). –°–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–≤—ñ—Ä—è—î –¥–∞—Ç—É –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ —Ç–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —É–∂–µ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∏—Ö —Ñ–æ–ª–æ—É–∞–ø—ñ–≤ (—Ç–µ–≥–∏ `followup-sent-*` —É —Ç–∞–±–ª–∏—Ü—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å) —ñ, —è–∫—â–æ –Ω–∞—Å—Ç–∞–≤ —á–∞—Å, –∑–∞–ø–∏—Å—É—î –Ω–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è–º —É `SUPABASE_MESSAGES_TABLE`.
- –í—ñ–¥–ø—Ä–∞–≤–∫—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –Ω–∞ –∫–∞–Ω–∞–ª–∏ (Telegram, ManyChat) –º–æ–∂–Ω–∞ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –≤–ª–∞—Å–Ω–∏–º —à–µ–¥—É–ª–µ—Ä–æ–º: –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ —Ü–µ–π –µ–Ω–¥–ø–æ—ñ–Ω—Ç —ñ –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ —Å—Ñ–æ—Ä–º–æ–≤–∞–Ω–∏–π —Ç–µ–∫—Å—Ç –Ω–∞ –ø–æ—Ç—Ä—ñ–±–Ω–∏–π –∫–∞–Ω–∞–ª.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç—É

```
src/
‚îú‚îÄ‚îÄ core/                      # Domain models —Ç–∞ utilities
‚îÇ   ‚îú‚îÄ‚îÄ state_machine.py       # ‚≠ê FSM: State, Intent, Transitions
‚îÇ   ‚îú‚îÄ‚îÄ models.py              # Pydantic: AgentResponse, Metadata (enum validators)
‚îÇ   ‚îú‚îÄ‚îÄ tool_planner.py        # Pre-LLM tool execution
‚îÇ   ‚îú‚îÄ‚îÄ product_adapter.py     # Product validation
‚îÇ   ‚îú‚îÄ‚îÄ input_validator.py     # Metadata validation
‚îÇ   ‚îú‚îÄ‚îÄ prompt_loader.py       # LLM-specific prompt loading
‚îÇ   ‚îî‚îÄ‚îÄ constants.py           # Legacy enums (backward compat)
‚îÇ
‚îú‚îÄ‚îÄ agents/                    # AI Agent layer
‚îÇ   ‚îú‚îÄ‚îÄ graph_v2.py            # ‚≠ê 5-node LangGraph v2
‚îÇ   ‚îú‚îÄ‚îÄ graph.py               # Legacy v1 graph
‚îÇ   ‚îú‚îÄ‚îÄ nodes.py               # Graph nodes
‚îÇ   ‚îî‚îÄ‚îÄ pydantic_agent.py      # Pydantic AI agent + Supabase tools
‚îÇ
‚îú‚îÄ‚îÄ services/                  # Business logic
‚îÇ   ‚îú‚îÄ‚îÄ observability.py       # ‚≠ê MetricsCollector, structured logs
‚îÇ   ‚îú‚îÄ‚îÄ moderation.py          # PII detection, content filtering
‚îÇ   ‚îú‚îÄ‚îÄ supabase_tools.py      # Supabase vector search
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ server/                    # FastAPI layer
‚îú‚îÄ‚îÄ bot/                       # Telegram integration
‚îî‚îÄ‚îÄ integrations/              # ManyChat, CRM

data/
‚îú‚îÄ‚îÄ prompts/                   # ‚≠ê LLM-specific prompts
‚îÇ   ‚îú‚îÄ‚îÄ base.yaml              # Base template
‚îÇ   ‚îú‚îÄ‚îÄ grok.yaml              # Grok 4.1 config
‚îÇ   ‚îú‚îÄ‚îÄ gpt.yaml               # GPT-5.1 config
‚îÇ   ‚îî‚îÄ‚îÄ gemini.yaml            # Gemini 3 Pro config
‚îú‚îÄ‚îÄ system_prompt_full.yaml    # Full prompt (legacy)
‚îú‚îÄ‚îÄ domain/                    # Business dictionaries
‚îÇ   ‚îú‚îÄ‚îÄ states.yaml
‚îÇ   ‚îî‚îÄ‚îÄ intents.yaml
‚îî‚îÄ‚îÄ catalog.json               # Product catalog

tests/
‚îú‚îÄ‚îÄ test_state_machine.py      # 21 FSM tests
‚îú‚îÄ‚îÄ test_product_adapter.py    # 13 validation tests
‚îú‚îÄ‚îÄ test_graph_v2.py           # 16 graph v2 tests
‚îî‚îÄ‚îÄ eval/                      # Golden dataset evaluation
```

## –¢–µ—Å—Ç–∏

```bash
# –ó–∞–ø—É—Å–∫ –≤—Å—ñ—Ö —Ç–µ—Å—Ç—ñ–≤ (50 passed)
pytest

# –¢—ñ–ª—å–∫–∏ v2 –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞
pytest tests/test_state_machine.py tests/test_product_adapter.py tests/test_graph_v2.py -v

# –ó coverage
pytest --cov=src --cov-report=html
```

| Test Suite | Tests | Coverage |
|------------|-------|----------|
| `test_state_machine.py` | 21 | FSM transitions, enums |
| `test_product_adapter.py` | 13 | Validation, price/url checks |
| `test_graph_v2.py` | 16 | 5-node graph, mocked LLM |

–¢–µ—Å—Ç–∏ –Ω–µ –≤–∏–∫–ª–∏–∫–∞—é—Ç—å –∑–æ–≤–Ω—ñ—à–Ω—ñ–π LLM ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è `AsyncMock` –∑–∞–≥–ª—É—à–∫–∞.

## CI/CD

GitHub Actions workflow (`.github/workflows/ci.yml`):
- **Lint** ‚Äî Ruff linter + formatter
- **Type Check** ‚Äî MyPy
- **Test** ‚Äî pytest –∑ coverage
- **Docker Build** ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–±—ñ—Ä–∫–∏ –æ–±—Ä–∞–∑—É
- **Security** ‚Äî Bandit + Safety

## –ë–µ–∑–ø–µ–∫–∞

| –ó–∞—Ö–∏—Å—Ç | –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è |
|--------|------------|
| Rate Limiting | 60 req/min per IP |
| SQL Injection | `validation.py` sanitization |
| Pattern Injection | `escape_like_pattern()` |
| PII Detection | Email, phone, card, passport regex |
| Leetspeak Bypass | Unicode normalization + substitution map |
| Input Validation | Product ID, URL, session ID validators |

## API Endpoints

| Method | Path | –û–ø–∏—Å |
|--------|------|------|
| GET | `/health` | Health check |
| POST | `/webhooks/telegram` | Telegram webhook |
| POST | `/webhooks/manychat` | ManyChat webhook |
| POST | `/automation/mirt-summarize-prod-v1` | Summarize old messages |
| POST | `/automation/mirt-followups-prod-v1` | Send follow-up reminders |

## –õ—ñ—Ü–µ–Ω–∑—ñ—è

MIT
