# ???????????

## ??????????

- **Web API (FastAPI)**: ?????? webhook/HTTP????????.
- **ManyChat ??????????**: push/response ?????, debounce, time budget.
- **LangGraph**: ??????? ??????????? ???????.
- **Checkpointer (Postgres)**: persistence ????? LangGraph.
- **Supabase Session Store**: ?????????? ???? ?????/???????????.
- **Celery + Redis**: ?????? ??????, follow?up, ??????? ?????.

## ????? ManyChat (push)

1) ManyChat ? `/webhooks/manychat` (202)
2) Async pipeline: debounce ? handler ? LangGraph
3) Push ????? ManyChat API

## ????? ManyChat (response)

1) ManyChat ? `/webhooks/manychat`
2) Debounce + handler ? ????????? v2

## ????? Telegram (???? ?????????)

1) Telegram webhook ? ????????
2) Debounce ? handler ? LangGraph
3) ????????? ????? ? Telegram

## ??????? ??????

- `src/integrations/manychat/pipeline.py` ? ?????? ???????? debounce + handler
- `src/integrations/manychat/async_service.py` ? push ?????
- `src/integrations/manychat/webhook.py` ? response ?????
- `src/agents/langgraph/*` ? ????, ?????, checkpointer
- `src/services/trim_policy.py` ? ????? ??????/trim

## ?????? ?? ???????

???? ?????? ??????? ? ????? ?????????? ? ????? ?????????? ? ?????????.

# Архітектура MIRT AI

## Головні компоненти

- **Web API (FastAPI)** – приймає вебхуки (ManyChat/Telegram/Snitkix) і REST-запити.
- **ManyChat інтеграція** – окремі режими push та response; керує debounce, time budget.
- **LangGraph** – основна оркестрація станів, HITL, інтеррапти.
- **Postgres Checkpointer** – зберігає повний стан LangGraph для resume/time-travel.
- **Supabase Session Store** – довготривале збереження клієнтських сесій/метаданих.
- **Celery + Redis** – фонові задачі (LLM воркери, follow-up, відправка ManyChat pushів).

## Потік ManyChat (push mode)
1. ManyChat викликає `/webhooks/manychat` → одразу 202.
2. `ManyChatAsyncService` через debounce збирає повідомлення.
3. LangGraph обробляє діалог → push-відповідь через ManyChat API.

## Потік ManyChat (response mode)
1. ManyChat викликає `/webhooks/manychat`.
2. Debounce + LangGraph.
3. Формуємо ManyChat v2 envelope та повертаємо у відповідь (sync).

## Telegram (полегшений режим)
1. Telegram webhook потрапляє до Bot/Dispatcher.
2. Debounce → LangGraph.
3. Відправка результату через Telegram Bot API.

## Ключові модулі

- `src/integrations/manychat/pipeline.py` – спільний пайплайн debounce + handler.
- `src/integrations/manychat/async_service.py` – push mode.
- `src/integrations/manychat/webhook.py` – response mode.
- `src/agents/langgraph/*` – стан, граф, checkpointer, вузли.
- `src/services/trim_policy.py` – soft/hard-limits для state/messages.

## Що ще важливо

Ця схема працює лише разом із Observability (див. `docs/OBSERVABILITY_RUNBOOK.md`) та FSM (див. `docs/FSM_TRANSITION_TABLE.md`), бо всі сервіси синхронізують `dialog_phase` і rely на спільних метриках.
