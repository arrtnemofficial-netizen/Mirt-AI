# ğŸ“± MIRT AI - ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ ManyChat + Instagram

## ĞĞ³Ğ»ÑĞ´ Ñ–Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ñ–Ñ—

```
Instagram DM â†’ ManyChat â†’ MIRT AI API â†’ AI Ğ¾Ğ±Ñ€Ğ¾Ğ±ĞºĞ° â†’ ManyChat Push â†’ Instagram DM
```

---

## ĞšÑ€Ğ¾Ğº 1: Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Flow Ğ² ManyChat

### 1.1 Trigger: Ğ±ÑƒĞ´ÑŒ-ÑĞºĞµ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ

1. Ğ’Ñ–Ğ´ĞºÑ€Ğ¸Ğ¹Ñ‚Ğµ ManyChat â†’ Automation â†’ Flows
2. Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ñ–Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ğ¸Ğ¹ Flow Ğ°Ğ±Ğ¾ Ğ²Ñ–Ğ´Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ¹Ñ‚Ğµ Ñ–ÑĞ½ÑƒÑÑ‡Ğ¸Ğ¹
3. Ğ”Ğ¾Ğ´Ğ°Ğ¹Ñ‚Ğµ Ñ‚Ñ€Ğ¸Ğ³ĞµÑ€ "Instagram Direct Message"

### 1.2 Ğ—Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ Ñ„Ğ¾Ñ‚Ğ¾ Ğ² Custom Field

**Ğ’ĞĞ–Ğ›Ğ˜Ğ’Ğ:** ManyChat Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ” `{{last_image_url}}` Ğ½Ğ°Ğ¿Ñ€ÑĞ¼Ñƒ Ğ² External Request.

**Ğ Ñ–ÑˆĞµĞ½Ğ½Ñ: Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒĞ¹Ñ‚Ğµ Condition + Set Custom Field**

```
IF Message contains Image
  â†’ Set Custom Field "user_image_url" = {{last_attachment_url}}
  â†’ Set Custom Field "user_message" = "[IMAGE]"
ELSE
  â†’ Set Custom Field "user_image_url" = ""
  â†’ Set Custom Field "user_message" = {{last_input_text}}
```

---

## ĞšÑ€Ğ¾Ğº 2: External Request Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ

### URL:
```
https://YOUR-DOMAIN.com/api/v1/messages
```

### Method:
```
POST
```

### Headers:
| Header | Value |
|--------|-------|
| X-API-Key | `kL2nM4oP6qR8sT0uV1wX3yZ5aB7cD9eF1gH3iJ5kL7mN9` |
| Content-Type | `application/json` |

### Body (JSON):

**Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ A: Ğ¢Ñ–Ğ»ÑŒĞºĞ¸ Ñ‚ĞµĞºÑÑ‚ (message Ğ¼Ğ¾Ğ¶Ğµ Ğ¼Ñ–ÑÑ‚Ğ¸Ñ‚Ğ¸ URL Ñ„Ğ¾Ñ‚Ğ¾)**
```json
{
  "sessionId": "{{user_id}}",
  "name": "{{full_name}}",
  "message": "{{last_input_text}}"
}
```

**Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ B: Ğ— Ğ¾ĞºÑ€ĞµĞ¼Ğ¸Ğ¼ Ğ¿Ğ¾Ğ»ĞµĞ¼ Ğ´Ğ»Ñ Ñ„Ğ¾Ñ‚Ğ¾ (Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ¾Ğ²Ğ°Ğ½Ğ¾)**
```json
{
  "type": "instagram",
  "clientId": "{{user_id}}",
  "clientName": "{{full_name}}",
  "message": "{{user_message}}",
  "image_url": "{{user_image_url}}"
}
```

> **ĞŸÑ€Ğ¸Ğ¼Ñ–Ñ‚ĞºĞ°:** `{{user_message}}` Ñ– `{{user_image_url}}` â€” Ñ†Ğµ Ğ²Ğ°ÑˆÑ– Custom Fields, ÑĞºÑ– Ğ²Ğ¸ Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ÑÑ”Ñ‚Ğµ Ñ‡ĞµÑ€ĞµĞ· Condition.

---

## ĞšÑ€Ğ¾Ğº 3: ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ñ„Ğ¾Ñ‚Ğ¾ (Ğ¿Ğ¾Ğ²Ğ½Ğ¸Ğ¹ Flow)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TRIGGER: Instagram Direct Message                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CONDITION: Message Type                                      â”‚
â”‚ IF {{last_attachment_type}} == "image"                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                              â”‚
          â–¼ YES                          â–¼ NO
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Set Custom Field:   â”‚    â”‚ Set Custom Field:               â”‚
â”‚ user_image_url =    â”‚    â”‚ user_image_url = ""             â”‚
â”‚ {{last_attachment_  â”‚    â”‚ user_message = {{last_input_    â”‚
â”‚ url}}               â”‚    â”‚ text}}                          â”‚
â”‚ user_message =      â”‚    â”‚                                 â”‚
â”‚ "[Ğ¤ĞĞ¢Ğ]"            â”‚    â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                              â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EXTERNAL REQUEST: POST to MIRT AI                            â”‚
â”‚ URL: https://your-domain.com/api/v1/messages                 â”‚
â”‚ Body:                                                        â”‚
â”‚ {                                                            â”‚
â”‚   "clientId": "{{user_id}}",                                 â”‚
â”‚   "message": "{{user_message}}",                             â”‚
â”‚   "image_url": "{{user_image_url}}"                          â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AI Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ°Ñ” Ñ‡ĞµÑ€ĞµĞ· Push API Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğ¾                     â”‚
â”‚ (Ğ½Ğµ Ğ¿Ğ¾Ñ‚Ñ€Ñ–Ğ±Ğ½Ğ¾ Ğ¾Ğ±Ñ€Ğ¾Ğ±Ğ»ÑÑ‚Ğ¸ response)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ĞšÑ€Ğ¾Ğº 4: ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ° - Dynamic Block

Ğ¯ĞºÑ‰Ğ¾ External Request Ğ½Ğµ Ğ¿Ñ€Ğ°Ñ†ÑÑ”, Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒĞ¹Ñ‚Ğµ **Dynamic Block**:

### URL:
```
https://YOUR-DOMAIN.com/webhooks/manychat
```

### Headers:
| Header | Value |
|--------|-------|
| X-Manychat-Token | `kL2nM4oP6qR8sT0uV1wX3yZ5aB7cD9eF1gH3iJ5kL7mN9` |

### Body:
```json
{
  "subscriber": {
    "id": {{user_id|to_json:true}},
    "name": {{full_name|to_json:true}}
  },
  "message": {
    "text": {{last_input_text|to_json:true}}
  },
  "data": {
    "image_url": {{user_image_url|to_json:true}}
  },
  "type": "instagram"
}
```

---

## ĞšÑ€Ğ¾Ğº 5: Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Custom Fields

Ğ’ ManyChat â†’ Settings â†’ Custom Fields ÑÑ‚Ğ²Ğ¾Ñ€Ñ–Ñ‚ÑŒ:

| Field Name | Type | Description |
|------------|------|-------------|
| `user_image_url` | Text | URL Ğ¾ÑÑ‚Ğ°Ğ½Ğ½ÑŒĞ¾Ğ³Ğ¾ Ñ„Ğ¾Ñ‚Ğ¾ Ğ²Ñ–Ğ´ ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ğ° |
| `user_message` | Text | Ğ¢ĞµĞºÑÑ‚ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ Ğ°Ğ±Ğ¾ "[Ğ¤ĞĞ¢Ğ]" |
| `ai_state` | Text | ĞŸĞ¾Ñ‚Ğ¾Ñ‡Ğ½Ğ¸Ğ¹ ÑÑ‚Ğ°Ğ½ AI Ğ´Ñ–Ğ°Ğ»Ğ¾Ğ³Ñƒ |
| `last_product` | Text | ĞÑÑ‚Ğ°Ğ½Ğ½Ñ–Ğ¹ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€ |

---

## Ğ¯Ğº AI Ğ¾Ğ±Ñ€Ğ¾Ğ±Ğ»ÑÑ” Ñ„Ğ¾Ñ‚Ğ¾

1. **ĞšĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡ Ğ½Ğ°Ğ´ÑĞ¸Ğ»Ğ°Ñ” Ñ„Ğ¾Ñ‚Ğ¾** â†’ ManyChat Ğ·Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ” URL Ğ² `user_image_url`
2. **External Request** Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ” URL Ğ² MIRT AI
3. **Vision Agent** Ğ°Ğ½Ğ°Ğ»Ñ–Ğ·ÑƒÑ” Ñ„Ğ¾Ñ‚Ğ¾ Ñ‡ĞµÑ€ĞµĞ· OpenAI Vision API
4. **AI Ğ·Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑŒ ÑÑ…Ğ¾Ğ¶Ñ– Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¸** Ğ² ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ·Ñ–
5. **Push API** Ğ²Ñ–Ğ´Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ” Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´ÑŒ + Ñ„Ğ¾Ñ‚Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ² Ğ½Ğ°Ğ·Ğ°Ğ´ Ğ² Instagram

---

## Ğ¢ĞµÑÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ

### 1. ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€Ñ‚Ğµ Ñ‰Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€ Ğ¿Ñ€Ğ°Ñ†ÑÑ”:
```bash
curl https://your-domain.com/health
```

### 2. ĞĞ°Ğ´Ñ–ÑˆĞ»Ñ–Ñ‚ÑŒ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğµ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ Ğ² Instagram

### 3. ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€Ñ‚Ğµ Ğ»Ğ¾Ğ³Ğ¸:
```bash
# Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾ (ngrok)
# Ğ”Ğ¸Ğ²Ñ–Ñ‚ÑŒÑÑ Ñ‚ĞµÑ€Ğ¼Ñ–Ğ½Ğ°Ğ» Ğ· python src/run.py

# ĞĞ° VPS
sudo journalctl -u mirt-ai -f
```

### 4. ĞÑ‡Ñ–ĞºÑƒĞ²Ğ°Ğ½Ñ– Ğ»Ğ¾Ğ³Ğ¸:
```
[API_V1] ğŸ“¥ RAW PAYLOAD: {"clientId":"123","message":"ĞŸÑ€Ğ¸Ğ²Ñ–Ñ‚","image_url":"https://..."}
[API_V1] âœ… Pydantic parsed:
[API_V1]    client_id: 123
[API_V1]    image_url: https://cdn.instagram.com/...
[MANYCHAT:123] ğŸ”¥ PROCESS_MESSAGE_ASYNC STARTED
[MANYCHAT:123] ğŸ“· Image URL set in metadata: https://cdn.instagram.com/...
```

---

## Troubleshooting

### Ğ¤Ğ¾Ñ‚Ğ¾ Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ”Ñ‚ÑŒÑÑ
**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** `image_url: None` Ğ² Ğ»Ğ¾Ğ³Ğ°Ñ…

**Ğ Ñ–ÑˆĞµĞ½Ğ½Ñ:**
1. ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€Ñ‚Ğµ Ñ‰Ğ¾ Custom Field `user_image_url` Ğ·Ğ°Ğ¿Ğ¾Ğ²Ğ½ÑÑ”Ñ‚ÑŒÑÑ
2. Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒĞ¹Ñ‚Ğµ Condition Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸ Ñ‚Ğ¸Ğ¿Ñƒ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ
3. ĞŸĞµÑ€ĞµĞºĞ¾Ğ½Ğ°Ğ¹Ñ‚ĞµÑÑŒ Ñ‰Ğ¾ `{{last_attachment_url}}` Ğ¿Ñ€Ğ°Ñ†ÑÑ” Ğ² Ğ²Ğ°ÑˆĞ¾Ğ¼Ñƒ Flow

### 401 Unauthorized
**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** ĞĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¸Ğ¹ Ñ‚Ğ¾ĞºĞµĞ½

**Ğ Ñ–ÑˆĞµĞ½Ğ½Ñ:** ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€Ñ‚Ğµ Ñ‰Ğ¾ `X-API-Key` Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ°Ñ” `MANYCHAT_VERIFY_TOKEN` Ğ² .env

### 400 Bad Request
**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** ĞĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¸Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ JSON

**Ğ Ñ–ÑˆĞµĞ½Ğ½Ñ:** 
- Ğ’ External Request ĞĞ• Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒĞ¹Ñ‚Ğµ `|to_json:true`
- Ğ’ Dynamic Block ĞĞ‘ĞĞ’'Ğ¯Ğ—ĞšĞĞ’Ğ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒĞ¹Ñ‚Ğµ `|to_json:true`

---

## ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¸ Ğ¿Ñ–Ğ´Ñ‚Ñ€Ğ¸Ğ¼ĞºĞ¸

ĞŸÑ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°Ñ… Ğ·Ğ²ĞµÑ€Ğ½Ñ–Ñ‚ÑŒÑÑ Ğ´Ğ¾ Ñ€Ğ¾Ğ·Ñ€Ğ¾Ğ±Ğ½Ğ¸ĞºĞ° Ğ· Ğ»Ğ¾Ğ³Ğ°Ğ¼Ğ¸ ÑĞµÑ€Ğ²ĞµÑ€Ğ°.
