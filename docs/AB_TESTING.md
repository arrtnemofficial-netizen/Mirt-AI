# A/B Testing –¥–ª—è MIRT AI

## üìã –û–≥–ª—è–¥

–°–∏—Å—Ç–µ–º–∞ A/B —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –¥–æ–∑–≤–æ–ª—è—î —Ç–µ—Å—Ç—É–≤–∞—Ç–∏ —Ä—ñ–∑–Ω—ñ –≤–∞—Ä—ñ–∞–Ω—Ç–∏ –ø—Ä–æ–º–ø—Ç—ñ–≤ –¥–ª—è –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –∫–æ–Ω–≤–µ—Ä—Å—ñ—ó —Ç–∞ —è–∫–æ—Å—Ç—ñ –¥—ñ–∞–ª–æ–≥—ñ–≤.

## üéØ –©–æ —Ç–µ—Å—Ç—É—î–º–æ

### –í–∞—Ä—ñ–∞–Ω—Ç A - –ë–∞–∑–æ–≤–∏–π
- –ü–æ—Ç–æ—á–Ω–∏–π –ø—Ä–æ–º–ø—Ç
- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥ –¥–æ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—ó
- –¢–µ–∫—Å—Ç ‚Üí –º–µ–¥—ñ–∞ ‚Üí –ø–∏—Ç–∞–Ω–Ω—è

### –í–∞—Ä—ñ–∞–Ω—Ç B - –í—ñ–∑—É–∞–ª—å–Ω–∏–π
- –ú–µ–¥—ñ–∞-first –ø—ñ–¥—Ö—ñ–¥
- –í—ñ–¥–µ–æ/—Ñ–æ—Ç–æ –æ–¥—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–ø–∏—Ç—ñ
- –°–∫–æ—Ä–æ—á–µ–Ω–∏–π —Ç–µ–∫—Å—Ç
- –®–≤–∏–¥—à–µ –¥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è

## üîí –û–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø—Ä–∞–≤–∏–ª–∞ (–¥–ª—è –≤—Å—ñ—Ö –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤)

### 1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ—Ä–æ–∂–Ω—ñ—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
```python
# –Ø–∫—â–æ text –ø–æ—Ä–æ–∂–Ω—ñ–π –∞–±–æ None
‚Üí –í–∏—Ö—ñ–¥: "–ù–µ–∑—Ä–æ–∑—É–º—ñ–ª–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∞–±–æ –Ω–µ–∑—Ä–æ–∑—É–º—ñ–ª–∏–π —Ñ–æ—Ä–º–∞—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è"
```

### 2. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –º–µ–¥—ñ–∞
```python
# –Ø–∫—â–æ —î —Ñ–æ—Ç–æ/–≤—ñ–¥–µ–æ/—Ñ–∞–π–ª
‚Üí –í–∏—Ö—ñ–¥: "–ù–µ–∑—Ä–æ–∑—É–º—ñ–ª–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∞–±–æ –Ω–µ–∑—Ä–æ–∑—É–º—ñ–ª–∏–π —Ñ–æ—Ä–º–∞—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è"
```

### 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ—Å–∏–ª–∞–Ω—å
```python
# –Ø–∫—â–æ —î http://, https://, www.
‚Üí –í–∏—Ö—ñ–¥: "–ù–µ–∑—Ä–æ–∑—É–º—ñ–ª–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∞–±–æ –Ω–µ–∑—Ä–æ–∑—É–º—ñ–ª–∏–π —Ñ–æ—Ä–º–∞—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è"
```

## üìä –ú–µ—Ç—Ä–∏–∫–∏

–í—ñ–¥—Å—Ç–µ–∂—É—î–º–æ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –≤–∞—Ä—ñ–∞–Ω—Ç—É:

| –ú–µ—Ç—Ä–∏–∫–∞                 | –û–ø–∏—Å                                        |
| ----------------------- | ------------------------------------------- |
| `conversion_rate`       | % –∑–∞–º–æ–≤–ª–µ–Ω—å –≤—ñ–¥ –¥—ñ–∞–ª–æ–≥—ñ–≤                    |
| `avg_messages_to_order` | –°–µ—Ä–µ–¥–Ω—è –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –¥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è |
| `escalation_rate`       | % –µ—Å–∫–∞–ª–∞—Ü—ñ–π –¥–æ –ª—é–¥–∏–Ω–∏                       |
| `json_error_rate`       | % –ø–æ–º–∏–ª–æ–∫ JSON                              |
| `state_error_rate`      | % –ø–æ–º–∏–ª–æ–∫ —Å—Ç–∞–Ω—ñ–≤                            |
| `avg_response_time`     | –°–µ—Ä–µ–¥–Ω—ñ–π —á–∞—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ                      |

## üöÄ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

### 1. –ë–∞–∑–æ–≤–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

```python
from src.core.ab_testing import get_ab_manager
from src.core.message_validator import validate_incoming_message

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
validation = validate_incoming_message(
    text=user_message,
    attachments=attachments,
)

if not validation.is_valid:
    # –í–∏—Ö—ñ–¥ –∑ –¥—ñ–∞–ª–æ–≥—É
    return exit_with_condition(validation.exit_condition)

# –û—Ç—Ä–∏–º–∞–Ω–Ω—è –≤–∞—Ä—ñ–∞–Ω—Ç—É –¥–ª—è —Å–µ—Å—ñ—ó
ab_manager = get_ab_manager()
variant_id = ab_manager.get_variant_for_session(session_id)
rules = ab_manager.get_variant_rules(session_id)

# –¢—Ä–µ–∫—ñ–Ω–≥
ab_manager.track_session_start(session_id)
ab_manager.track_message(session_id, response_time=2.5)
ab_manager.track_conversion(session_id)  # –ü—Ä–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—ñ
```

### 2. –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –≤ conversation handler

```python
async def process_message(self, session_id: str, text: str, attachments=None):
    # 1. –í–∞–ª—ñ–¥–∞—Ü—ñ—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    validation = validate_incoming_message(text, attachments)
    if not validation.is_valid:
        return self._build_exit_response(validation.exit_condition)
    
    # 2. –û—Ç—Ä–∏–º–∞–Ω–Ω—è –≤–∞—Ä—ñ–∞–Ω—Ç—É
    variant_rules = get_variant_rules(session_id)
    
    # 3. –û–±—Ä–æ–±–∫–∞ –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –ø—Ä–∞–≤–∏–ª –≤–∞—Ä—ñ–∞–Ω—Ç—É
    if variant_rules.get("auto_send_media"):
        # –í–∞—Ä—ñ–∞–Ω—Ç B - –æ–¥—Ä–∞–∑—É –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ –º–µ–¥—ñ–∞
        pass
    
    # 4. –¢—Ä–µ–∫—ñ–Ω–≥
    track_message(session_id, response_time)
```

## üìà –ü–µ—Ä–µ–≥–ª—è–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤

```python
from src.core.ab_testing import get_ab_manager

ab_manager = get_ab_manager()

# –û—Ç—Ä–∏–º–∞—Ç–∏ –º–µ—Ç—Ä–∏–∫–∏
summary = ab_manager.get_metrics_summary()
print(summary)

# –í–∏–∑–Ω–∞—á–∏—Ç–∏ –ø–µ—Ä–µ–º–æ–∂—Ü—è
winner = ab_manager.get_winning_variant(min_sample_size=100)
print(f"Winning variant: {winner}")
```

### –ü—Ä–∏–∫–ª–∞–¥ –≤–∏–≤–æ–¥—É:

```json
{
  "variant_a": {
    "name": "–ë–∞–∑–æ–≤–∏–π –ø—Ä–æ–º–ø—Ç",
    "total_sessions": 150,
    "conversions": 45,
    "conversion_rate": "30.00%",
    "avg_messages_to_order": "8.5",
    "escalation_rate": "5.33%"
  },
  "variant_b": {
    "name": "–í—ñ–∑—É–∞–ª—å–Ω–∏–π –ø—Ä–æ–º–ø—Ç",
    "total_sessions": 145,
    "conversions": 52,
    "conversion_rate": "35.86%",
    "avg_messages_to_order": "6.2",
    "escalation_rate": "4.14%"
  }
}
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è

–§–∞–π–ª: `data/prompts/prompt_variants.yaml`

```yaml
VARIANTS:
  variant_a:
    weight: 50  # 50% —Ç—Ä–∞—Ñ—ñ–∫—É
    enabled: true
  
  variant_b:
    weight: 50  # 50% —Ç—Ä–∞—Ñ—ñ–∫—É
    enabled: true
```

### –ó–º—ñ–Ω–∞ —Ä–æ–∑–ø–æ–¥—ñ–ª—É —Ç—Ä–∞—Ñ—ñ–∫—É

```yaml
# 80% –Ω–∞ –≤–∞—Ä—ñ–∞–Ω—Ç A, 20% –Ω–∞ –≤–∞—Ä—ñ–∞–Ω—Ç B
variant_a:
  weight: 80
variant_b:
  weight: 20
```

### –í–∏–º–∫–Ω–µ–Ω–Ω—è –≤–∞—Ä—ñ–∞–Ω—Ç—É

```yaml
variant_b:
  enabled: false  # –í–µ—Å—å —Ç—Ä–∞—Ñ—ñ–∫ –ø—ñ–¥–µ –Ω–∞ variant_a
```

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Ç–µ—Å—Ç–∏ A/B —Å–∏—Å—Ç–µ–º–∏
python -m pytest tests/test_ab_testing.py -v

# –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Ç–µ—Å—Ç–∏ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
python -m pytest tests/test_message_validator.py -v
```

## üìù –ü—Ä–∞–≤–∏–ª–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤

1. –î–æ–¥–∞—Ç–∏ –≤–∞—Ä—ñ–∞–Ω—Ç —É `prompt_variants.yaml`
2. –°—Ç–≤–æ—Ä–∏—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –¥–ª—è –≤–∞—Ä—ñ–∞–Ω—Ç—É
3. –î–æ–¥–∞—Ç–∏ —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ –ø—Ä–∞–≤–∏–ª–∞
4. –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Ç–µ—Å—Ç–∏
5. –ú–æ–Ω—ñ—Ç–æ—Ä–∏—Ç–∏ –º–µ—Ç—Ä–∏–∫–∏

## ‚ö†Ô∏è –í–∞–∂–ª–∏–≤–æ

- **–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ –≤–∏–±—ñ—Ä–∫–∞**: 100 —Å–µ—Å—ñ–π –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–Ω–æ—ó –∑–Ω–∞—á—É—â–æ—Å—Ç—ñ
- **–†—ñ–≤–µ–Ω—å –¥–æ–≤—ñ—Ä–∏**: 95%
- **–ß–∞—Å —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è**: –ú—ñ–Ω—ñ–º—É–º 1 —Ç–∏–∂–¥–µ–Ω—å
- **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –º–µ–¥—ñ–∞**: –ó–∞–≤–∂–¥–∏ –∞–∫—Ç–∏–≤–Ω–∞ –¥–ª—è –≤—Å—ñ—Ö –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤
- **–ü–æ—Ä–æ–∂–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è**: –ó–∞–≤–∂–¥–∏ –≤—ñ–¥—Ö–∏–ª—è—é—Ç—å—Å—è

## üîÑ –ü—Ä–æ—Ü–µ—Å –ø—Ä–∏–π–Ω—è—Ç—Ç—è —Ä—ñ—à–µ–Ω–Ω—è

1. –ó–±—ñ—Ä –¥–∞–Ω–∏—Ö (–º—ñ–Ω. 100 —Å–µ—Å—ñ–π –Ω–∞ –≤–∞—Ä—ñ–∞–Ω—Ç)
2. –ê–Ω–∞–ª—ñ–∑ –º–µ—Ç—Ä–∏–∫
3. –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –ø–µ—Ä–µ–º–æ–∂—Ü—è
4. –ü–æ—Å—Ç—É–ø–æ–≤–µ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—è —Ç—Ä–∞—Ñ—ñ–∫—É (80/20, –ø–æ—Ç—ñ–º 100/0)
5. –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –ø—ñ—Å–ª—è –∑–º—ñ–Ω–∏

## üìû –ü—ñ–¥—Ç—Ä–∏–º–∫–∞

–ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –∑ A/B —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è–º:
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ª–æ–≥–∏: `logs/ab_testing.log`
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é: `data/prompts/prompt_variants.yaml`
- –°–∫–∏–Ω—É—Ç–∏ –º–µ—Ç—Ä–∏–∫–∏: `ab_manager.metrics.clear()`
