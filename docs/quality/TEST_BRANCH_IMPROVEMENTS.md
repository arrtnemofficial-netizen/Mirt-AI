# üîÑ –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –∑ –≥—ñ–ª–∫–∏ `test` –¥–ª—è `main`

**–î–∞—Ç–∞:** 24.12.2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –¥–æ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è

---

## üéØ –í–∏—Å–Ω–æ–≤–æ–∫

–ù–∞ –≥—ñ–ª—Ü—ñ `test` —î **3 –∫—Ä–∏—Ç–∏—á–Ω—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è**, —è–∫—ñ –≤–∞—Ä—Ç–æ –¥–æ–¥–∞—Ç–∏ –Ω–∞ `main`:

1. ‚úÖ **Webhook dedupe schema** - –ø–æ–≤–Ω–∞ schema –∑ UNIQUE constraint
2. ‚úÖ **Connection pool cleanup** - graceful shutdown checkpointer pool
3. ‚úÖ **Rate limiter** - –Ω–∞ `test` –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ in-memory (–±–µ–∑ Redis fail-open –ø—Ä–æ–±–ª–µ–º–∏)

---

## üìã –î–µ—Ç–∞–ª—å–Ω–∏–π –ê–Ω–∞–ª—ñ–∑

### 1. ‚úÖ Webhook Dedupe Schema (–ö–†–ò–¢–ò–ß–ù–û)

**–ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞ `main`:**
- –ù–µ–º–∞—î SQL schema —Ñ–∞–π–ª—É –¥–ª—è `webhook_dedupe` table
- –ú–æ–∂–ª–∏–≤–æ —Ç–∞–±–ª–∏—Ü—è –Ω–µ –º–∞—î UNIQUE constraint –Ω–∞ `dedupe_key`
- Race condition –Ω–µ –∑–∞—Ö–∏—â–µ–Ω–æ –Ω–∞ —Ä—ñ–≤–Ω—ñ –ë–î

**–†—ñ—à–µ–Ω–Ω—è –Ω–∞ `test`:**
- ‚úÖ –Ñ –ø–æ–≤–Ω–∞ schema: `src/db/webhook_dedupe_schema.sql`
- ‚úÖ `dedupe_key text not null unique` - –∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ race condition
- ‚úÖ Index –Ω–∞ `expires_at` –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ cleanup
- ‚úÖ Function `cleanup_expired_webhook_dedupe()` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ cleanup

**–©–æ –≤–∑—è—Ç–∏ –∑ `test`:**
```sql
-- src/db/webhook_dedupe_schema.sql (–ø–æ–≤–Ω–∞ –≤–µ—Ä—Å—ñ—è)
create table if not exists public.webhook_dedupe (
    id bigint generated by default as identity primary key,
    dedupe_key text not null unique,  -- ‚Üê –ö–†–ò–¢–ò–ß–ù–û: UNIQUE constraint
    processed_at timestamptz not null default now(),
    expires_at timestamptz not null,
    
    constraint webhook_dedupe_expires_at_check check (expires_at > processed_at)
);

create index if not exists idx_webhook_dedupe_expires_at 
    on public.webhook_dedupe using btree (expires_at);

create index if not exists idx_webhook_dedupe_processed_at 
    on public.webhook_dedupe using btree (processed_at);

-- Function –¥–ª—è cleanup
create or replace function cleanup_expired_webhook_dedupe()
returns integer
language plpgsql
as $$
declare
    deleted_count integer;
begin
    delete from public.webhook_dedupe
    where expires_at < now();
    
    get diagnostics deleted_count = row_count;
    
    return deleted_count;
end;
$$;
```

**–î—ñ—è:**
1. –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ `src/db/webhook_dedupe_schema.sql` –∑ `test` –Ω–∞ `main`
2. –ó–∞–ø—É—Å—Ç–∏—Ç–∏ migration –≤ production

**–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç:** üî¥ **HIGH** (–∑–∞—Ö–∏—â–∞—î –≤—ñ–¥ race condition)

---

### 2. ‚úÖ Connection Pool Cleanup (–í–ê–ñ–õ–ò–í–û)

**–ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞ `main`:**
- –ù–µ–º–∞—î —è–≤–Ω–æ–≥–æ cleanup connection pool –ø—Ä–∏ shutdown
- –ú–æ–∂–µ –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ "connection leak" warnings –≤ –ª–æ–≥–∞—Ö

**–†—ñ—à–µ–Ω–Ω—è –Ω–∞ `test`:**
- ‚úÖ –Ñ `shutdown_checkpointer_pool()` —Ñ—É–Ω–∫—Ü—ñ—è –≤ `checkpointer.py`
- ‚úÖ –í–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –≤ lifespan shutdown (`src/server/main.py:139-143`)

**–©–æ –≤–∑—è—Ç–∏ –∑ `test`:**

#### A. –§—É–Ω–∫—Ü—ñ—è shutdown –≤ `checkpointer.py`:
```python
# src/agents/langgraph/checkpointer.py
async def shutdown_checkpointer_pool() -> None:
    """Gracefully close checkpointer pool on application shutdown.
    
    This should be called during application shutdown to properly close
    database connections and avoid connection leaks.
    """
    global _pool_instance
    if _pool_instance is None:
        return
    
    pool = _pool_instance
    _pool_instance = None
    
    try:
        if hasattr(pool, "close"):
            # Give active connections time to finish (max 5 seconds)
            await asyncio.wait_for(pool.close(), timeout=5.0)
            logger.info("[CHECKPOINTER] Pool closed gracefully")
        elif hasattr(pool, "wait"):
            # Some pool implementations use wait() instead
            await asyncio.wait_for(pool.wait(), timeout=5.0)
            logger.info("[CHECKPOINTER] Pool closed gracefully")
    except asyncio.TimeoutError:
        logger.warning("[CHECKPOINTER] Pool close timed out, forcing shutdown")
    except Exception as e:
        logger.warning("[CHECKPOINTER] Error closing pool: %s", e)
```

#### B. –í–∏–∫–ª–∏–∫ –≤ lifespan shutdown:
```python
# src/server/main.py (–≤ lifespan shutdown)
yield

# Shutdown
logger.info("Shutting down MIRT AI Webhooks server")

# Gracefully close checkpointer pool
try:
    from src.agents.langgraph.checkpointer import shutdown_checkpointer_pool
    await shutdown_checkpointer_pool()
except Exception as e:
    logger.warning("Failed to shutdown checkpointer pool: %s", e)
```

**–î—ñ—è:**
1. –î–æ–¥–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é `shutdown_checkpointer_pool()` –≤ `src/agents/langgraph/checkpointer.py`
2. –î–æ–¥–∞—Ç–∏ –≤–∏–∫–ª–∏–∫ –≤ `src/server/main.py` lifespan shutdown

**–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç:** üü° **MEDIUM** (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –∞–ª–µ –∫—Ä–∞—â–µ –º–∞—Ç–∏)

---

### 3. ‚úÖ Rate Limiter (–ù–ï –ü–†–û–ë–õ–ï–ú–ê –Ω–∞ `test`)

**–ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞ `main`:**
- Redis rate limiter –º–∞—î fail-open behavior (–¥–æ–∑–≤–æ–ª—è—î –∑–∞–ø–∏—Ç–∏ —è–∫—â–æ Redis –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π)
- –ú–æ–∂–µ –±—É—Ç–∏ –ø—Ä–æ–±–ª–µ–º–æ—é –ø—Ä–∏ DDoS

**–†—ñ—à–µ–Ω–Ω—è –Ω–∞ `test`:**
- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ `InMemoryRateLimiter` (–±–µ–∑ Redis)
- ‚úÖ –ù–µ–º–∞—î –ø—Ä–æ–±–ª–µ–º–∏ –∑ fail-open

**–í–∏—Å–Ω–æ–≤–æ–∫:**
- –ù–∞ `test` –Ω–µ–º–∞—î Redis, —Ç–æ–º—É –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –∞–∫—Ç—É–∞–ª—å–Ω–∞
- –ù–∞ `main` –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ in-memory fallback (–≤–∂–µ —î `InMemoryRateLimiter`)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è –¥–ª—è `main`:**
```python
# src/server/middleware.py:278-281
except Exception as e:
    logger.error("Redis rate limit check failed: %s", e)
    # Fallback to in-memory limiter instead of fail-open
    in_memory_limiter = InMemoryRateLimiter(self.config)
    return in_memory_limiter.check_rate_limit(request)
```

**–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç:** üü° **MEDIUM** (–∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Ä–∏–∑–∏–∫—É DDoS)

---

### 4. ‚ö†Ô∏è Debouncer (–û–î–ù–ê–ö–û–í–û –Ω–∞ –æ–±–æ—Ö –≥—ñ–ª–∫–∞—Ö)

**–ü—Ä–æ–±–ª–µ–º–∞:**
- In-memory dict –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î—Ç—å—Å—è –º—ñ–∂ —Å–µ—Ä–≤–µ—Ä–∞–º–∏
- –ù–∞ –æ–±–æ—Ö –≥—ñ–ª–∫–∞—Ö (`test` —ñ `main`) –æ–¥–Ω–∞–∫–æ–≤–∞ –ø—Ä–æ–±–ª–µ–º–∞

**–í–∏—Å–Ω–æ–≤–æ–∫:**
- –ù–∞ `test` –Ω–µ–º–∞—î –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –¥–ª—è debouncer
- –ü—Ä–æ–±–ª–µ–º–∞ –æ–¥–Ω–∞–∫–æ–≤–∞ –Ω–∞ –æ–±–æ—Ö –≥—ñ–ª–∫–∞—Ö

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:**
- –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ multi-instance support, –¥–æ–¥–∞—Ç–∏ Redis –¥–ª—è shared state (—è–∫ rate limiter)

**–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç:** üü¢ **LOW** (—è–∫—â–æ —î sticky sessions, —Ç–æ –Ω–µ –ø—Ä–æ–±–ª–µ–º–∞)

---

## üéØ –ü–ª–∞–Ω –î—ñ–π

### –ö—Ä–æ–∫ 1: –î–æ–¥–∞—Ç–∏ Webhook Dedupe Schema (HIGH)
```bash
# –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –∑ test
git show test:src/db/webhook_dedupe_schema.sql > src/db/webhook_dedupe_schema.sql

# –ó–∞–ø—É—Å—Ç–∏—Ç–∏ migration –≤ production
```

### –ö—Ä–æ–∫ 2: –î–æ–¥–∞—Ç–∏ Connection Pool Cleanup (MEDIUM)
```bash
# –î–æ–¥–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é shutdown_checkpointer_pool() –≤ checkpointer.py
# –î–æ–¥–∞—Ç–∏ –≤–∏–∫–ª–∏–∫ –≤ main.py lifespan shutdown
```

### –ö—Ä–æ–∫ 3: –ü–æ–∫—Ä–∞—â–∏—Ç–∏ Rate Limiter (MEDIUM)
```bash
# –î–æ–¥–∞—Ç–∏ in-memory fallback –∑–∞–º—ñ—Å—Ç—å fail-open
```

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç

- [ ] –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ `src/db/webhook_dedupe_schema.sql` –∑ `test`
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç–∏ migration –≤ production
- [ ] –î–æ–¥–∞—Ç–∏ `shutdown_checkpointer_pool()` –≤ `checkpointer.py`
- [ ] –î–æ–¥–∞—Ç–∏ –≤–∏–∫–ª–∏–∫ shutdown –≤ `main.py` lifespan
- [ ] (–û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ) –ü–æ–∫—Ä–∞—â–∏—Ç–∏ rate limiter –∑ in-memory fallback

---

## üìä –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | `main` | `test` | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è |
|-----------|--------|-------|--------------|
| **Webhook dedupe schema** | ‚ùå –ù–µ–º–∞—î | ‚úÖ –Ñ –∑ UNIQUE | –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –∑ `test` |
| **Connection pool cleanup** | ‚ùå –ù–µ–º–∞—î | ‚úÖ –Ñ shutdown | –î–æ–¥–∞—Ç–∏ –∑ `test` |
| **Rate limiter** | ‚ö†Ô∏è Redis fail-open | ‚úÖ In-memory only | –ü–æ–∫—Ä–∞—â–∏—Ç–∏ –Ω–∞ `main` |
| **Debouncer** | ‚ö†Ô∏è In-memory | ‚ö†Ô∏è In-memory | –û–¥–Ω–∞–∫–æ–≤–æ –Ω–∞ –æ–±–æ—Ö |

---

**–û–Ω–æ–≤–ª–µ–Ω–æ:** 24 –≥—Ä—É–¥–Ω—è 2025, 22:00 UTC+2

