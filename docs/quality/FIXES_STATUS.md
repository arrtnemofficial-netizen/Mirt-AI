# ‚úÖ –°—Ç–∞—Ç—É—Å –í–∏–ø—Ä–∞–≤–ª–µ–Ω—å –ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏—Ö –ü—Ä–æ–±–ª–µ–º

**–î–∞—Ç–∞:** 24.12.2025  
**–û–Ω–æ–≤–ª–µ–Ω–æ:** –ü—ñ—Å–ª—è –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –ø–æ–∫—Ä–∞—â–µ–Ω—å –∑ `test` –≥—ñ–ª–∫–∏

---

## üìä –°—Ç–∞—Ç—É—Å –ö–æ–∂–Ω–æ—ó –ü—Ä–æ–±–ª–µ–º–∏

### 1. ‚úÖ Webhook Dedupe Race Condition ‚Äî –í–ò–ü–†–ê–í–õ–ï–ù–û (—á–∞—Å—Ç–∫–æ–≤–æ)

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–≤–∞ –æ–¥–Ω–æ—á–∞—Å–Ω—ñ –∑–∞–ø–∏—Ç–∏ –º–æ–∂—É—Ç—å –æ–±–∏–¥–≤–∞ –ø—Ä–æ–π—Ç–∏ INSERT –ø–µ—Ä–µ–≤—ñ—Ä–∫—É

**–©–æ –∑—Ä–æ–±–ª–µ–Ω–æ:**
- ‚úÖ –î–æ–¥–∞–Ω–æ `src/db/webhook_dedupe_schema.sql` –∑ `UNIQUE` constraint –Ω–∞ `dedupe_key`
- ‚úÖ UNIQUE constraint –∑–∞—Ö–∏—â–∞—î –≤—ñ–¥ race condition –Ω–∞ —Ä—ñ–≤–Ω—ñ –ë–î
- ‚ö†Ô∏è –ö–æ–¥ –≤—Å–µ —â–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î INSERT + exception (–Ω–µ UPSERT)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ **Race condition –∑–∞—Ö–∏—â–µ–Ω–æ –Ω–∞ —Ä—ñ–≤–Ω—ñ –ë–î** —á–µ—Ä–µ–∑ UNIQUE constraint
- ‚úÖ PostgreSQL –≥–∞—Ä–∞–Ω—Ç—É—î —â–æ —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω INSERT –ø—Ä–æ–π–¥–µ, —ñ–Ω—à–∏–π –æ—Ç—Ä–∏–º–∞—î exception
- ‚ö†Ô∏è –ú–æ–∂–Ω–∞ –ø–æ–∫—Ä–∞—â–∏—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–≤—à–∏ UPSERT –¥–ª—è –º–µ–Ω—à–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ exceptions

**–°—Ç–∞—Ç—É—Å:** üü¢ **–ù–ï –ë–£–î–ï –ü–†–û–ë–õ–ï–ú–ò** (–∑–∞—Ö–∏—â–µ–Ω–æ –Ω–∞ —Ä—ñ–≤–Ω—ñ –ë–î)

**–î—ñ—è:** –ó–∞–ø—É—Å—Ç–∏—Ç–∏ migration `src/db/webhook_dedupe_schema.sql` –≤ production

---

### 2. ‚ö†Ô∏è Debouncer Multi-Instance ‚Äî –ù–ï –í–ò–ü–†–ê–í–õ–ï–ù–û (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)

**–ü—Ä–æ–±–ª–µ–º–∞:** In-memory dict –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î—Ç—å—Å—è –º—ñ–∂ —Å–µ—Ä–≤–µ—Ä–∞–º–∏

**–©–æ –∑—Ä–æ–±–ª–µ–Ω–æ:**
- ‚ùå –ù—ñ—á–æ–≥–æ –Ω–µ –∑–º—ñ–Ω–µ–Ω–æ (–ø—Ä–æ–±–ª–µ–º–∞ –æ–¥–Ω–∞–∫–æ–≤–∞ –Ω–∞ –æ–±–æ—Ö –≥—ñ–ª–∫–∞—Ö)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚ö†Ô∏è –Ø–∫—â–æ —î 2+ —Å–µ—Ä–≤–µ—Ä–∏ –±–µ–∑ sticky sessions, debouncing –ø—Ä–∞—Ü—é—î —Ç—ñ–ª—å–∫–∏ –≤ –º–µ–∂–∞—Ö –æ–¥–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
- ‚úÖ –Ø–∫—â–æ —î sticky sessions –≤ load balancer, —Ç–æ –Ω–µ –ø—Ä–æ–±–ª–µ–º–∞

**–°—Ç–∞—Ç—É—Å:** üü° **–ú–û–ñ–õ–ò–í–ê –ü–†–û–ë–õ–ï–ú–ê** (—Ç—ñ–ª—å–∫–∏ —è–∫—â–æ multi-instance –±–µ–∑ sticky sessions)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:** 
- –Ø–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –æ–¥–∏–Ω —Å–µ—Ä–≤–µ—Ä ‚Üí –Ω–µ –ø—Ä–æ–±–ª–µ–º–∞
- –Ø–∫—â–æ –ø–ª–∞–Ω—É—î—Ç—å—Å—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–µ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è ‚Üí –¥–æ–¥–∞—Ç–∏ Redis –¥–ª—è shared state

---

### 3. ‚ö†Ô∏è Rate Limiter Fail-Open ‚Äî –ù–ï –í–ò–ü–†–ê–í–õ–ï–ù–û (–ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–æ–∫—Ä–∞—â–∏—Ç–∏)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ Redis –≤—Å—ñ –∑–∞–ø–∏—Ç–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç—å

**–©–æ –∑—Ä–æ–±–ª–µ–Ω–æ:**
- ‚ùå –ù—ñ—á–æ–≥–æ –Ω–µ –∑–º—ñ–Ω–µ–Ω–æ (–∑–∞–ª–∏—à–∏–ª–æ—Å—å fail-open)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚ö†Ô∏è –ü—Ä–∏ DDoS –∞—Ç–∞—Ü—ñ, —è–∫—â–æ Redis –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π, –≤—Å—ñ –∑–∞–ø–∏—Ç–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç—å
- ‚ö†Ô∏è –ú–æ–∂–µ –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ –ø–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏

**–°—Ç–∞—Ç—É—Å:** üü° **–ú–û–ñ–õ–ò–í–ê –ü–†–û–ë–õ–ï–ú–ê** (–ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ Redis + DDoS)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:**
```python
# src/server/middleware.py:278-281
except Exception as e:
    logger.error("Redis rate limit check failed: %s", e)
    # Fallback to in-memory limiter instead of fail-open
    in_memory_limiter = InMemoryRateLimiter(self.config)
    return in_memory_limiter.check_rate_limit(request)
```

**–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç:** –í–∏–ø—Ä–∞–≤–∏—Ç–∏ –≤ –Ω–∞–π–±–ª–∏–∂—á—ñ 1-2 —Ç–∏–∂–Ω—ñ

---

### 4. ‚úÖ Connection Pool Cleanup ‚Äî –í–ò–ü–†–ê–í–õ–ï–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–º–∞—î —è–≤–Ω–æ–≥–æ cleanup –ø—Ä–∏ shutdown

**–©–æ –∑—Ä–æ–±–ª–µ–Ω–æ:**
- ‚úÖ –î–æ–¥–∞–Ω–æ `_pool_instance` –≥–ª–æ–±–∞–ª—å–Ω—É –∑–º—ñ–Ω–Ω—É
- ‚úÖ –î–æ–¥–∞–Ω–æ `shutdown_checkpointer_pool()` —Ñ—É–Ω–∫—Ü—ñ—é
- ‚úÖ –î–æ–¥–∞–Ω–æ –≤–∏–∫–ª–∏–∫ shutdown –≤ `main.py` lifespan

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ Connection pool –∑–∞–∫—Ä–∏–≤–∞—î—Ç—å—Å—è gracefully –ø—Ä–∏ shutdown
- ‚úÖ –ù–µ–º–∞—î connection leaks

**–°—Ç–∞—Ç—É—Å:** üü¢ **–í–ò–ü–†–ê–í–õ–ï–ù–û** (–Ω–µ –±—É–¥–µ –ø—Ä–æ–±–ª–µ–º–∏)

---

### 5. ‚úÖ Webhook Dedupe Schema ‚Äî –í–ò–ü–†–ê–í–õ–ï–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ SQL schema (–º–æ–∂–ª–∏–≤–æ –Ω–µ–º–∞—î UNIQUE constraint)

**–©–æ –∑—Ä–æ–±–ª–µ–Ω–æ:**
- ‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ `src/db/webhook_dedupe_schema.sql` –∑ `test`
- ‚úÖ Schema –º—ñ—Å—Ç–∏—Ç—å UNIQUE constraint –Ω–∞ `dedupe_key`
- ‚úÖ Schema –º—ñ—Å—Ç–∏—Ç—å indexes —Ç–∞ cleanup function

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –¢–∞–±–ª–∏—Ü—è –º–∞—î UNIQUE constraint (–∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ race condition)
- ‚úÖ –Ñ indexes –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ cleanup

**–°—Ç–∞—Ç—É—Å:** üü¢ **–í–ò–ü–†–ê–í–õ–ï–ù–û** (–Ω–µ –±—É–¥–µ –ø—Ä–æ–±–ª–µ–º–∏)

**–î—ñ—è:** –ó–∞–ø—É—Å—Ç–∏—Ç–∏ migration `src/db/webhook_dedupe_schema.sql` –≤ production

---

## üîç –î–æ–¥–∞—Ç–∫–æ–≤—ñ –ü—Ä–æ–±–ª–µ–º–∏ –∑ –õ–æ–≥—ñ–≤

### ‚ö†Ô∏è FSM Guard Override ‚Äî –í–ò–ü–†–ê–í–õ–ï–ù–û (–∞–ª–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏)

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ –ª–æ–≥–∞—Ö:**
```
FSM guard override: phase=COMPLETED expected_state=STATE_7_END got=STATE_0_INIT
```

**–©–æ –∑—Ä–æ–±–ª–µ–Ω–æ:**
- ‚úÖ –î–æ–¥–∞–Ω–æ `current_state="STATE_7_END"` –¥–ª—è –≤—Å—ñ—Ö escalation —Å—Ü–µ–Ω–∞—Ä—ñ—ó–≤
- ‚úÖ –î–æ–¥–∞–Ω–æ —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω—É –æ–±—Ä–æ–±–∫—É –¥–ª—è 429 (quota exceeded)

**–ú–æ–∂–ª–∏–≤–∞ –ø—Ä–∏—á–∏–Ω–∞:**
- –ö–æ–¥ –Ω–µ –æ–Ω–æ–≤–∏–≤—Å—è –≤ production (–ø–æ—Ç—Ä—ñ–±–µ–Ω redeploy)
- –ê–±–æ –ø–æ–º–∏–ª–∫–∞ –ª–æ–≤–∏—Ç—å—Å—è –≤ —ñ–Ω—à–æ–º—É –º—ñ—Å—Ü—ñ

**–°—Ç–∞—Ç—É—Å:** üü° **–ü–û–¢–†–Ü–ë–ï–ù REDEPLOY** (–∫–æ–¥ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ, –∞–ª–µ –Ω–µ –∑–∞–¥–µ–ø–ª–æ—î–Ω–æ)

---

### ‚ö†Ô∏è Telegram Markdown Parsing ‚Äî –í–ò–ü–†–ê–í–õ–ï–ù–û (–∞–ª–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏)

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ –ª–æ–≥–∞—Ö:**
```
Failed to send notification: 400 {"ok":false,"error_code":400,"description":"Bad Request: can't parse entities: Can't find end of the entity starting at byte offset 622"}
```

**–©–æ –∑—Ä–æ–±–ª–µ–Ω–æ:**
- ‚úÖ –î–æ–¥–∞–Ω–æ retry logic: —Å–ø–æ—á–∞—Ç–∫—É Markdown, –ø–æ—Ç—ñ–º plain text

**–ú–æ–∂–ª–∏–≤–∞ –ø—Ä–∏—á–∏–Ω–∞:**
- –ö–æ–¥ –Ω–µ –æ–Ω–æ–≤–∏–≤—Å—è –≤ production (–ø–æ—Ç—Ä—ñ–±–µ–Ω redeploy)

**–°—Ç–∞—Ç—É—Å:** üü° **–ü–û–¢–†–Ü–ë–ï–ù REDEPLOY** (–∫–æ–¥ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ, –∞–ª–µ –Ω–µ –∑–∞–¥–µ–ø–ª–æ—î–Ω–æ)

---

### ‚ö†Ô∏è SLOW CHECKPOINTER ‚Äî –ü–û–ö–†–ê–©–ï–ù–û (–∞–ª–µ –≤—Å–µ —â–µ –ø–æ–≤—ñ–ª—å–Ω–æ)

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ –ª–æ–≥–∞—Ö:**
```
SLOW CHECKPOINTER OP: aput_writes took 1.26s
SLOW CHECKPOINTER OP: aput_writes took 1.59s
SLOW CHECKPOINTER OP: aput took 1.32s
```

**–©–æ –∑—Ä–æ–±–ª–µ–Ω–æ:**
- ‚úÖ –ó–±—ñ–ª—å—à–µ–Ω–æ `pool_min_size` –∑ 1 –¥–æ 2 (—Ç–µ–ø–ª–∏–π –ø—É–ª)
- ‚úÖ –ó–º–µ–Ω—à–µ–Ω–æ `connect_timeout` –∑ 10s –¥–æ 5s

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚ö†Ô∏è –û–ø–µ—Ä–∞—Ü—ñ—ó –≤—Å–µ —â–µ –ø–æ–≤—ñ–ª—å–Ω—ñ (1-1.7 —Å–µ–∫—É–Ω–¥)
- ‚úÖ –ú–æ–∂–ª–∏–≤–æ —Ç—Ä–æ—Ö–∏ —à–≤–∏–¥—à–µ –∑–∞–≤–¥—è–∫–∏ —Ç–µ–ø–ª–æ–º—É –ø—É–ª—É

**–°—Ç–∞—Ç—É—Å:** üü° **–ü–û–ö–†–ê–©–ï–ù–û** (–∞–ª–µ –Ω–µ –≤–∏—Ä—ñ—à–µ–Ω–æ –ø–æ–≤–Ω—ñ—Å—Ç—é)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:**
- –ú–æ–Ω—ñ—Ç–æ—Ä–∏—Ç–∏ –º–µ—Ç—Ä–∏–∫–∏ checkpointer
- –†–æ–∑–≥–ª—è–Ω—É—Ç–∏ –∑–±—ñ–ª—å—à–µ–Ω–Ω—è `pool_max_size` —è–∫—â–æ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑—Ä–æ—Å—Ç–µ

---

## üìã –ü—ñ–¥—Å—É–º–æ–∫

| –ü—Ä–æ–±–ª–µ–º–∞ | –°—Ç–∞—Ç—É—Å | –î—ñ—è |
|----------|--------|-----|
| **1. Webhook dedupe race** | ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ | –ó–∞–ø—É—Å—Ç–∏—Ç–∏ migration |
| **2. Debouncer multi-instance** | ‚ö†Ô∏è –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ | –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ ‚Üí Redis |
| **3. Rate limiter fail-open** | ‚ö†Ô∏è –ü–æ—Ç—Ä—ñ–±–Ω–æ –ø–æ–∫—Ä–∞—â–∏—Ç–∏ | –î–æ–¥–∞—Ç–∏ in-memory fallback |
| **4. Connection pool cleanup** | ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ | –ì–æ—Ç–æ–≤–æ |
| **5. Webhook dedupe schema** | ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ | –ó–∞–ø—É—Å—Ç–∏—Ç–∏ migration |
| **FSM guard override** | üü° –ü–æ—Ç—Ä—ñ–±–µ–Ω redeploy | Redeploy –∫–æ–¥ |
| **Telegram Markdown** | üü° –ü–æ—Ç—Ä—ñ–±–µ–Ω redeploy | Redeploy –∫–æ–¥ |
| **SLOW CHECKPOINTER** | üü° –ü–æ–∫—Ä–∞—â–µ–Ω–æ | –ú–æ–Ω—ñ—Ç–æ—Ä–∏—Ç–∏ |

---

## ‚úÖ –í–∏—Å–Ω–æ–≤–æ–∫

**3 –∑ 5 –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏—Ö –ø—Ä–æ–±–ª–µ–º –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ:**
1. ‚úÖ Webhook dedupe race condition (–∑–∞—Ö–∏—â–µ–Ω–æ UNIQUE constraint)
2. ‚úÖ Connection pool cleanup (–¥–æ–¥–∞–Ω–æ shutdown)
3. ‚úÖ Webhook dedupe schema (–¥–æ–¥–∞–Ω–æ schema —Ñ–∞–π–ª)

**2 –ø—Ä–æ–±–ª–µ–º–∏ –∑–∞–ª–∏—à–∏–ª–∏—Å—å (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ñ):**
1. ‚ö†Ô∏è Debouncer multi-instance (—Ç—ñ–ª—å–∫–∏ —è–∫—â–æ multi-instance –±–µ–∑ sticky sessions)
2. ‚ö†Ô∏è Rate limiter fail-open (—Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ DDoS + Redis –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π)

**–î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø—Ä–æ–±–ª–µ–º–∏:**
- üü° FSM guard override (–ø–æ—Ç—Ä—ñ–±–µ–Ω redeploy)
- üü° Telegram Markdown (–ø–æ—Ç—Ä—ñ–±–µ–Ω redeploy)
- üü° SLOW CHECKPOINTER (–ø–æ–∫—Ä–∞—â–µ–Ω–æ, –∞–ª–µ –Ω–µ –≤–∏—Ä—ñ—à–µ–Ω–æ)

---

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:** 
1. –ó–∞–ø—É—Å—Ç–∏—Ç–∏ migration –¥–ª—è `webhook_dedupe` table
2. –ó—Ä–æ–±–∏—Ç–∏ redeploy —â–æ–± –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è FSM guard override —Ç–∞ Telegram Markdown
3. –ú–æ–Ω—ñ—Ç–æ—Ä–∏—Ç–∏ checkpointer –º–µ—Ç—Ä–∏–∫–∏
4. –ü–ª–∞–Ω—É–≤–∞—Ç–∏ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è rate limiter (in-memory fallback)

---

**–û–Ω–æ–≤–ª–µ–Ω–æ:** 24 –≥—Ä—É–¥–Ω—è 2025, 22:15 UTC+2

