# üîç –ê–ù–ê–õ–Ü–ó –ö–û–°–¢–ò–õ–Ü–í - ZB_ENGINE_V6

**–î–∞—Ç–∞:** 2025-12-23  
**–†–µ–∂–∏–º:** MODE_C_GUIDED_IMPLEMENTATION  
**–¢–∏–ø –∑–∞–¥–∞—á—ñ:** ARCHITECTURE + CODE_QUALITY

---

## WORKING_BRIEF

**goal:** –ó–Ω–∞–π—Ç–∏ –≤—Å—ñ –∫–æ—Å—Ç–∏–ª—ñ –≤ –ø—Ä–æ—î–∫—Ç—ñ, —è–∫—ñ –∑—Ä–æ–±–ª–µ–Ω—ñ "–≤–æ–ø—Ä–æ—Å–æ–º –Ω–∞—Ö—É—è" —ñ –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –∫–æ—Ä–µ–Ω–µ–≤—ñ –ø—Ä–∏—á–∏–Ω–∏

**scope_in:**
- Hardcoded fallback –∑–Ω–∞—á–µ–Ω–Ω—è –∑–∞–º—ñ—Å—Ç—å SSOT
- Stub –∫–ª–∞—Å–∏ –∑ –∫–æ–º–µ–Ω—Ç–∞—Ä—è–º–∏ "TODO" –∞–±–æ "For now"
- Temporary —Ñ–ª–∞–≥–∏ —è–∫—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –¥–æ–≤–≥–æ
- Silent failures (except –±–µ–∑ –ª–æ–≥—É–≤–∞–Ω–Ω—è)
- Fallback –ª–æ–≥—ñ–∫–∞ —Ç–∞–º –¥–µ –Ω–µ –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏

**scope_out:**
- –õ–æ–≥—ñ—á–Ω—ñ fallback –¥–ª—è fault tolerance (circuit breaker, retry)
- –í–∞–ª—ñ–¥–∞—Ü—ñ—è –∑ graceful degradation
- Feature flags –¥–ª—è A/B —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

**facts:**
- FACT: –ó–Ω–∞–π–¥–µ–Ω–æ hardcoded fallback_mapping –≤ `src/agents/pydantic/main_agent.py:215-230`
- FACT: –ó–Ω–∞–π–¥–µ–Ω–æ stub –∫–ª–∞—Å `CRMErrorHandler` –∑ –∫–æ–º–µ–Ω—Ç–∞—Ä–µ–º "Stub" –≤ `src/integrations/crm/error_handler.py:15`
- FACT: –ó–Ω–∞–π–¥–µ–Ω–æ temporary —Ñ–ª–∞–≥ `ENABLE_LEGACY_STATE_ALIASES` –≤ `src/conf/config.py:192-195`
- FACT: –ó–Ω–∞–π–¥–µ–Ω–æ TODO –≤ `src/services/data/catalog_service.py:85`
- FACT: –ó–Ω–∞–π–¥–µ–Ω–æ –±–∞–≥–∞—Ç–æ `except Exception:` –±–µ–∑ –ª–æ–≥—É–≤–∞–Ω–Ω—è (41+ –º—ñ—Å—Ü—å)

**unknowns:**
- –ß–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è ENABLE_LEGACY_STATE_ALIASES –≤ production?
- –ß–∏ —î –ø–ª–∞–Ω —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó vector search?
- –ß–∏ —î –ø–ª–∞–Ω —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó CRM retry logic?

**next_verification:** –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∫–æ–∂–µ–Ω –∫–æ—Å—Ç–∏–ª—å –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ñ—Å—Ç—å —ñ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø–ª–∞–Ω –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

---

## TASK_TYPE_AND_MODE

**task_type:** ARCHITECTURE  
**why:** –ö–æ—Å—Ç–∏–ª—ñ –≤–ø–ª–∏–≤–∞—é—Ç—å –Ω–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä—É —Ç–∞ –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω—ñ—Å—Ç—å –∫–æ–¥—É  
**primary_risk:** –¢–µ—Ö–Ω—ñ—á–Ω–∏–π –±–æ—Ä–≥, —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å –ø—ñ–¥—Ç—Ä–∏–º–∫–∏, –º–æ–∂–ª–∏–≤—ñ –±–∞–≥–∏  
**fastest_proof:** –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–¥—É –Ω–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å hardcoded –∑–Ω–∞—á–µ–Ω—å —Ç–∞ stub –∫–ª–∞—Å—ñ–≤  
**mode:** MODE_C_GUIDED_IMPLEMENTATION

---

## FINDINGS (FACT ONLY)

### 1. HARDCODED FALLBACK –ó–ù–ê–ß–ï–ù–ù–Ø

**–§–∞–π–ª:** `src/agents/pydantic/main_agent.py:215-230`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
fallback_mapping = [
    {"min": 80, "max": 92, "sizes": ["80-92", "80", "86", "92"]},
    # ... 11 —Ä—è–¥–∫—ñ–≤ hardcoded –¥–∞–Ω–∏—Ö
]
fallback_border = {120: "122-128", 131: "134-140", 143: "146-152", 155: "158-164"}
```

**–ö–æ—Ä–µ–Ω–µ–≤–∞ –ø—Ä–∏—á–∏–Ω–∞:** 
- SSOT —Ñ–∞–π–ª `size_guide.yaml` –º–æ–∂–µ –±—É—Ç–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π
- –ó–∞–º—ñ—Å—Ç—å —Ç–æ–≥–æ —â–æ–± –∑—Ä–æ–±–∏—Ç–∏ —Å–∏—Å—Ç–µ–º—É –Ω–∞–¥—ñ–π–Ω—ñ—à–æ—é, –¥–æ–¥–∞–ª–∏ hardcoded fallback
- –î–∞–Ω—ñ –¥—É–±–ª—é—é—Ç—å—Å—è –≤ –¥–≤–æ—Ö –º—ñ—Å—Ü—è—Ö (YAML + –∫–æ–¥)

**–†–∏–∑–∏–∫:** 
- –î–∞–Ω—ñ –º–æ–∂—É—Ç—å —Ä–æ–∑—ñ–π—Ç–∏—Å—è –º—ñ–∂ YAML —ñ –∫–æ–¥–æ–º
- –í–∞–∂–∫–æ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ —Ä–æ–∑–º—ñ—Ä–Ω—É —Å—ñ—Ç–∫—É (—Ç—Ä–µ–±–∞ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –∫–æ–¥)
- –ù–µ–º–∞—î –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —â–æ fallback –∞–∫—Ç—É–∞–ª—å–Ω–∏–π

**VERIFY:** –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ `size_guide.yaml` –∑–∞–≤–∂–¥–∏ –¥–æ—Å—Ç—É–ø–Ω–∏–π –≤ production

---

### 2. STUB –ö–õ–ê–° –ë–ï–ó –†–ï–ê–õ–Ü–ó–ê–¶–Ü–á

**–§–∞–π–ª:** `src/integrations/crm/error_handler.py:14-59`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
class CRMErrorHandler:
    """Stub for CRM error handling logic."""
    
    async def retry_crm_order_in_state(...):
        # Logic for actual retry would go here
        # For now, we return success and expect caller to handle the loop
        return {"status": "retrying", ...}
```

**–ö–æ—Ä–µ–Ω–µ–≤–∞ –ø—Ä–∏—á–∏–Ω–∞:**
- –ö–ª–∞—Å –ø–æ–º—ñ—á–µ–Ω–∏–π —è–∫ "Stub" –∞–ª–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤ production
- –ú–µ—Ç–æ–¥ `retry_crm_order_in_state` –Ω–µ —Ä–æ–±–∏—Ç—å —Ä–µ–∞–ª—å–Ω–æ–≥–æ retry
- –ö–æ–º–µ–Ω—Ç–∞—Ä "For now" –≤–∫–∞–∑—É—î –Ω–∞ —Ç–∏–º—á–∞—Å–æ–≤—ñ—Å—Ç—å –∞–ª–µ –Ω—ñ—á–æ–≥–æ –Ω–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ

**–†–∏–∑–∏–∫:**
- CRM retry –Ω–µ –ø—Ä–∞—Ü—é—î –Ω–∞—Å–ø—Ä–∞–≤–¥—ñ
- –ú–æ–∂–ª–∏–≤—ñ –≤—Ç—Ä–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω—å –ø—Ä–∏ —Ç–∏–º—á–∞—Å–æ–≤–∏—Ö –ø–æ–º–∏–ª–∫–∞—Ö CRM
- –û–º–∞–Ω–ª–∏–≤–∞ –Ω–∞–∑–≤–∞ –º–µ—Ç–æ–¥—É (retry –Ω–µ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è)

**VERIFY:** –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è `retry_crm_order_in_state` –≤ production

---

### 3. TEMPORARY –§–õ–ê–ì –ë–ï–ó –ü–õ–ê–ù–£ –í–ò–î–ê–õ–ï–ù–ù–Ø

**–§–∞–π–ª:** `src/conf/config.py:192-195`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
ENABLE_LEGACY_STATE_ALIASES: bool = Field(
    default=True,
    description="Allow legacy state aliases in normalize_state (temporary).",
)
```

**–ö–æ—Ä–µ–Ω–µ–≤–∞ –ø—Ä–∏—á–∏–Ω–∞:**
- –§–ª–∞–≥ –ø–æ–º—ñ—á–µ–Ω–∏–π —è–∫ "temporary" –∞–ª–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è
- –ù–µ–º–∞—î –ø–ª–∞–Ω—É –º—ñ–≥—Ä–∞—Ü—ñ—ó –∞–±–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è
- –ù–µ—è—Å–Ω–æ —â–æ —Ç–∞–∫–µ "legacy state aliases" —ñ —á–æ–º—É –≤–æ–Ω–∏ –ø–æ—Ç—Ä—ñ–±–Ω—ñ

**–†–∏–∑–∏–∫:**
- –§–ª–∞–≥ –º–æ–∂–µ –∑–∞–ª–∏—à–∏—Ç–∏—Å—è –Ω–∞–∑–∞–≤–∂–¥–∏
- –ù–µ–º–∞—î –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó —â–æ —Å–∞–º–µ —Ä–æ–±–∏—Ç—å —Ü–µ–π —Ñ–ª–∞–≥
- –ú–æ–∂–µ –ø—Ä–∏—Ö–æ–≤—É–≤–∞—Ç–∏ –ø—Ä–æ–±–ª–µ–º–∏ –∑ –º—ñ–≥—Ä–∞—Ü—ñ—î—é —Å—Ç–∞–Ω—ñ–≤

**VERIFY:** –ó–Ω–∞–π—Ç–∏ –¥–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è `ENABLE_LEGACY_STATE_ALIASES` —ñ —â–æ –≤–æ–Ω–æ —Ä–æ–±–∏—Ç—å

---

### 4. TODO –ë–ï–ó –ü–õ–ê–ù–£ –†–ï–ê–õ–Ü–ó–ê–¶–Ü–á

**–§–∞–π–ª:** `src/services/data/catalog_service.py:85`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# TODO: Implement vector search when embeddings are ready.
# For now, uses simple text search on name/description.
```

**–ö–æ—Ä–µ–Ω–µ–≤–∞ –ø—Ä–∏—á–∏–Ω–∞:**
- TODO –±–µ–∑ –¥–∞—Ç–∏ –∞–±–æ –ø–ª–∞–Ω—É
- –ù–µ—è—Å–Ω–æ –∫–æ–ª–∏ "embeddings are ready"
- –ú–æ–∂–ª–∏–≤–æ vector search –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω –≤–∑–∞–≥–∞–ª—ñ

**–†–∏–∑–∏–∫:**
- TODO –º–æ–∂–µ –∑–∞–ª–∏—à–∏—Ç–∏—Å—è –Ω–∞–∑–∞–≤–∂–¥–∏
- –ù–µ—è—Å–Ω–æ —á–∏ —Ü–µ –≤–∑–∞–≥–∞–ª—ñ –ø–æ—Ç—Ä—ñ–±–Ω–æ
- –ú–æ–∂–µ –±—É—Ç–∏ premature optimization

**VERIFY:** –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ —î embeddings –≤ –ø—Ä–æ—î–∫—Ç—ñ —ñ —á–∏ –ø–æ—Ç—Ä—ñ–±–µ–Ω vector search

---

### 5. SILENT FAILURES (EXCEPT –ë–ï–ó –õ–û–ì–£–í–ê–ù–ù–Ø)

**–§–∞–π–ª–∏:** –ë–∞–≥–∞—Ç–æ –º—ñ—Å—Ü—å (41+ –∑–Ω–∞–π–¥–µ–Ω–æ)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
except Exception:
    pass  # –∞–±–æ –ø—Ä–æ—Å—Ç–æ continue
```

**–ü—Ä–∏–∫–ª–∞–¥–∏:**
- `src/services/data/catalog_service.py:41, 54, 64` - except –±–µ–∑ –ª–æ–≥—É–≤–∞–Ω–Ω—è
- `src/agents/langgraph/checkpointer.py:356` - except –±–µ–∑ –ª–æ–≥—É–≤–∞–Ω–Ω—è

**–ö–æ—Ä–µ–Ω–µ–≤–∞ –ø—Ä–∏—á–∏–Ω–∞:**
- –ü–æ–º–∏–ª–∫–∏ –ø—Ä–∏—Ö–æ–≤—É—é—Ç—å—Å—è –∑–∞–º—ñ—Å—Ç—å –ª–æ–≥—É–≤–∞–Ω–Ω—è
- –ù–µ–º–æ–∂–ª–∏–≤–æ –¥—ñ–∞–≥–Ω–æ—Å—Ç—É–≤–∞—Ç–∏ –ø—Ä–æ–±–ª–µ–º–∏
- –ú–æ–∂–µ –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ —Ç–∏—Ö–∏—Ö –±–∞–≥—ñ–≤

**–†–∏–∑–∏–∫:**
- –í—Ç—Ä–∞—Ç–∞ –¥–∞–Ω–∏—Ö –±–µ–∑ –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è
- –°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º
- –ú–æ–∂–ª–∏–≤—ñ security issues (–ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫)

**VERIFY:** –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∫–æ–∂–µ–Ω `except Exception:` —á–∏ —î –ª–æ–≥—É–≤–∞–Ω–Ω—è

---

## RISKS

1. **–¢–µ—Ö–Ω—ñ—á–Ω–∏–π –±–æ—Ä–≥:** –ö–æ—Å—Ç–∏–ª—ñ –Ω–∞–∫–æ–ø–∏—á—É—é—Ç—å—Å—è —ñ —É—Å–∫–ª–∞–¥–Ω—é—é—Ç—å –ø—ñ–¥—Ç—Ä–∏–º–∫—É
2. **–í—Ç—Ä–∞—Ç–∞ –¥–∞–Ω–∏—Ö:** Silent failures –º–æ–∂—É—Ç—å –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ –≤—Ç—Ä–∞—Ç–∏ –≤–∞–∂–ª–∏–≤–∏—Ö –¥–∞–Ω–∏—Ö
3. **–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:** –ù–µ–º–æ–∂–ª–∏–≤–æ –∑—Ä–æ–∑—É–º—ñ—Ç–∏ —â–æ –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫
4. **–†–æ–∑–±—ñ–∂–Ω—ñ—Å—Ç—å –¥–∞–Ω–∏—Ö:** Hardcoded fallback –º–æ–∂–µ —Ä–æ–∑—ñ–π—Ç–∏—Å—è –∑ SSOT

---

## OPTIONS_AND_CHOICE

### Option 1: –ü–û–°–¢–£–ü–û–í–ï –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø (RECOMMENDED)

**–©–æ —Ä–æ–±–∏–º–æ:**
1. –í–∏–¥–∞–ª–∏—Ç–∏ hardcoded fallback, –∑—Ä–æ–±–∏—Ç–∏ —Å–∏—Å—Ç–µ–º—É –Ω–∞–¥—ñ–π–Ω—ñ—à–æ—é (–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ YAML –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ)
2. –†–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –∞–±–æ –≤–∏–¥–∞–ª–∏—Ç–∏ stub –∫–ª–∞—Å CRMErrorHandler
3. –î–æ–∫—É–º–µ–Ω—Ç—É–≤–∞—Ç–∏ –∞–±–æ –≤–∏–¥–∞–ª–∏—Ç–∏ ENABLE_LEGACY_STATE_ALIASES
4. –í–∏—Ä—ñ—à–∏—Ç–∏ –∞–±–æ –≤–∏–¥–∞–ª–∏—Ç–∏ TODO –ø—Ä–æ vector search
5. –î–æ–¥–∞—Ç–∏ –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–æ –≤—Å—ñ—Ö except –±–ª–æ–∫—ñ–≤

**–ö–æ–º–ø—Ä–æ–º—ñ—Å–∏:**
- –ü–æ—Ç—Ä—ñ–±–µ–Ω —á–∞—Å –Ω–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥
- –ú–æ–∂–ª–∏–≤—ñ breaking changes
- –ü–æ—Ç—Ä—ñ–±–Ω—ñ —Ç–µ—Å—Ç–∏

**–ß–æ–º—É —Ü–µ–π –≤–∞—Ä—ñ–∞–Ω—Ç:**
- –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π —Ä–∏–∑–∏–∫ (–ø–æ—Å—Ç—É–ø–æ–≤–æ)
- –ú–æ–∂–Ω–∞ —Ç–µ—Å—Ç—É–≤–∞—Ç–∏ –∫–æ–∂–Ω–µ –∑–º—ñ–Ω–µ–Ω–Ω—è –æ–∫—Ä–µ–º–æ
- –ù–µ –±–ª–æ–∫—É—î —ñ–Ω—à—ñ –∑–∞–¥–∞—á—ñ

### Option 2: –í–ò–î–ê–õ–ò–¢–ò –í–°–ï –û–î–†–ê–ó–£

**–©–æ —Ä–æ–±–∏–º–æ:**
- –í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –∫–æ—Å—Ç–∏–ª—ñ –æ–¥—Ä–∞–∑—É
- –ó–∞–º—ñ–Ω–∏—Ç–∏ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ —Ä—ñ—à–µ–Ω–Ω—è

**–ö–æ–º–ø—Ä–æ–º—ñ—Å–∏:**
- –í–∏—Å–æ–∫–∏–π —Ä–∏–∑–∏–∫ breaking changes
- –ü–æ—Ç—Ä—ñ–±–Ω—ñ –≤–µ–ª–∏–∫—ñ —Ç–µ—Å—Ç–∏
- –ú–æ–∂–µ –∑–ª–∞–º–∞—Ç–∏ production

**–ß–æ–º—É –ù–ï —Ü–µ–π –≤–∞—Ä—ñ–∞–Ω—Ç:**
- –ó–∞–Ω–∞–¥—Ç–æ —Ä–∏–∑–∏–∫–æ–≤–∞–Ω–æ
- –ú–æ–∂–µ –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ downtime

---

## PLAN

### Step 1: –ê–ù–ê–õ–Ü–ó –ö–û–ñ–ù–û–ì–û –ö–û–°–¢–ò–õ–Ø
- **ACTION:** –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∫–æ–∂–µ–Ω –∫–æ—Å—Ç–∏–ª—å –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ñ—Å—Ç—å
- **RISK:** –ú–æ–∂–ª–∏–≤–æ –¥–µ—è–∫—ñ –∫–æ—Å—Ç–∏–ª—ñ –≤—Å–µ —â–µ –ø–æ—Ç—Ä—ñ–±–Ω—ñ
- **VERIFY:** –°—Ç–≤–æ—Ä–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –∫–æ—Å—Ç–∏–ª—ñ–≤ –∑ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–∞–º–∏
- **ARTIFACT:** `KOSTYLI_PRIORITY_LIST.md`

### Step 2: –í–ò–ü–†–ê–í–ò–¢–ò HARDCODED FALLBACK
- **ACTION:** –í–∏–¥–∞–ª–∏—Ç–∏ fallback_mapping, –¥–æ–¥–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É YAML –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
- **RISK:** –ú–æ–∂–ª–∏–≤–∏–π downtime —è–∫—â–æ YAML –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π
- **VERIFY:** –¢–µ—Å—Ç —â–æ —Å–∏—Å—Ç–µ–º–∞ –ø–∞–¥–∞—î –∑—Ä–æ–∑—É–º—ñ–ª–æ—é –ø–æ–º–∏–ª–∫–æ—é —è–∫—â–æ YAML –≤—ñ–¥—Å—É—Ç–Ω—ñ–π
- **ARTIFACT:** –û–Ω–æ–≤–ª–µ–Ω–∏–π `main_agent.py` + —Ç–µ—Å—Ç–∏

### Step 3: –í–ò–†–Ü–®–ò–¢–ò STUB –ö–õ–ê–°
- **ACTION:** –ê–±–æ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ retry logic, –∞–±–æ –≤–∏–¥–∞–ª–∏—Ç–∏ –∫–ª–∞—Å
- **RISK:** –ú–æ–∂–ª–∏–≤—ñ breaking changes –≤ CRM —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó
- **VERIFY:** –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –∫–ª–∞—Å –≤ production
- **ARTIFACT:** –û–Ω–æ–≤–ª–µ–Ω–∏–π `error_handler.py` –∞–±–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è

### Step 4: –í–ò–†–Ü–®–ò–¢–ò TEMPORARY –§–õ–ê–ì
- **ACTION:** –î–æ–∫—É–º–µ–Ω—Ç—É–≤–∞—Ç–∏ –∞–±–æ –≤–∏–¥–∞–ª–∏—Ç–∏ ENABLE_LEGACY_STATE_ALIASES
- **RISK:** –ú–æ–∂–ª–∏–≤—ñ –ø—Ä–æ–±–ª–µ–º–∏ –∑ –º—ñ–≥—Ä–∞—Ü—ñ—î—é —Å—Ç–∞–Ω—ñ–≤
- **VERIFY:** –ó–Ω–∞–π—Ç–∏ –≤—Å—ñ –º—ñ—Å—Ü—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ñ–ª–∞–≥—É
- **ARTIFACT:** –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è –∞–±–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Ñ–ª–∞–≥—É

### Step 5: –î–û–î–ê–¢–ò –õ–û–ì–£–í–ê–ù–ù–Ø –î–û EXCEPT
- **ACTION:** –î–æ–¥–∞—Ç–∏ –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–æ –≤—Å—ñ—Ö except –±–ª–æ–∫—ñ–≤ –±–µ–∑ –ª–æ–≥—É–≤–∞–Ω–Ω—è
- **RISK:** –ú–æ–∂–ª–∏–≤–∏–π spam –≤ –ª–æ–≥–∞—Ö
- **VERIFY:** –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —â–æ –≤—Å—ñ except –±–ª–æ–∫–∏ –ª–æ–≥—É—é—Ç—å –ø–æ–º–∏–ª–∫–∏
- **ARTIFACT:** –û–Ω–æ–≤–ª–µ–Ω–∏–π –∫–æ–¥ –∑ –ª–æ–≥—É–≤–∞–Ω–Ω—è–º

---

## VERIFICATION_MAP

| AC | Status | Evidence | Repro | Notes |
|---|---|---|---|---|
| –í—Å—ñ –∫–æ—Å—Ç–∏–ª—ñ –∑–Ω–∞–π–¥–µ–Ω—ñ —Ç–∞ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤–∞–Ω—ñ | VERIFIED | –¶–µ–π —Ñ–∞–π–ª | grep –ø–æ –∫–æ–¥—É | - |
| Hardcoded fallback –≤–∏–¥–∞–ª–µ–Ω–æ | NOT_VERIFIED | - | –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ main_agent.py | –ü–æ—Ç—Ä—ñ–±–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è |
| Stub –∫–ª–∞—Å –≤–∏—Ä—ñ—à–µ–Ω–æ | NOT_VERIFIED | - | –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ error_handler.py | –ü–æ—Ç—Ä—ñ–±–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è |
| Temporary —Ñ–ª–∞–≥ –≤–∏—Ä—ñ—à–µ–Ω–æ | NOT_VERIFIED | - | –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ config.py | –ü–æ—Ç—Ä—ñ–±–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è |
| –í—Å—ñ except –±–ª–æ–∫–∏ –ª–æ–≥—É—é—Ç—å | NOT_VERIFIED | - | grep –ø–æ –∫–æ–¥—É | –ü–æ—Ç—Ä—ñ–±–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è |

---

## NEXT_REQUEST

**–©–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ:**
1. –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–∏ –∫–æ—Å—Ç–∏–ª—ñ–≤
2. –ü–æ—á–∞—Ç–∏ –∑ –Ω–∞–π–∫—Ä–∏—Ç–∏—á–Ω—ñ—à–∏—Ö (hardcoded fallback, silent failures)
3. –°—Ç–≤–æ—Ä–∏—Ç–∏ –¥–µ—Ç–∞–ª—å–Ω–∏–π –ø–ª–∞–Ω –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –∫–æ—Å—Ç–∏–ª—è

**–ê—Ä—Ç–µ—Ñ–∞–∫—Ç–∏ –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –∫—Ä–æ–∫—É:**
- –°–ø–∏—Å–æ–∫ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç—ñ–≤ –∫–æ—Å—Ç–∏–ª—ñ–≤
- –î–µ—Ç–∞–ª—å–Ω–∏–π –ø–ª–∞–Ω –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –∫–æ–∂–Ω–æ–≥–æ –∫–æ—Å—Ç–∏–ª—è
- –¢–µ—Å—Ç–∏ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å

