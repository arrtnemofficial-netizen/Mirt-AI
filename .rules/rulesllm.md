# –ó–ê–õ–Ü–ó–û–ë–ï–¢–û–ù–ù–ò–ô –ö–û–î–ï–ö–° –†–û–ó–†–û–ë–ö–ò (CODE OF CONDUCT)

> **‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–ê –Ü–ù–°–¢–†–£–ö–¶–Ü–Ø –î–õ–Ø AI AGENTS –¢–ê –†–û–ó–†–û–ë–ù–ò–ö–Ü–í:**
> –¶–µ–π –¥–æ–∫—É–º–µ–Ω—Ç –≤–∏–∑–Ω–∞—á–∞—î **–ù–ï–ü–û–†–£–®–ù–Ü –ó–ê–ö–û–ù–ò** –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏ –ø—Ä–æ–µ–∫—Ç—É MIRT AI.
> –ë—É–¥—å-—è–∫–µ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è –≤—ñ–¥ —Ü–∏—Ö –ø—Ä–∞–≤–∏–ª –≤–≤–∞–∂–∞—î—Ç—å—Å—è **–ö–†–ò–¢–ò–ß–ù–û–Æ –ü–û–ú–ò–õ–ö–û–Æ**.
> –ü—Ä–æ—á–∏—Ç–∞–π —Ü–µ –ø–µ—Ä–µ–¥ –Ω–∞–ø–∏—Å–∞–Ω–Ω—è–º —Ö–æ—á–∞ –± –æ–¥–Ω–æ–≥–æ —Ä—è–¥–∫–∞ –∫–æ–¥—É.

---

## 0. –ü—Ä–æ –ø—Ä–æ–µ–∫—Ç (–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è AI)

**MIRT AI** ‚Äî —Ü–µ AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –¥–ª—è –º–∞–≥–∞–∑–∏–Ω—É –¥–∏—Ç—è—á–æ–≥–æ –æ–¥—è–≥—É MIRT.
*   **–ú–æ–≤–∞ —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è –∑ –∫–ª—ñ—î–Ω—Ç–∞–º–∏:** –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞.
*   **–ü–ª–∞—Ç—Ñ–æ—Ä–º–∏:** Instagram (—á–µ—Ä–µ–∑ ManyChat), Telegram.
*   **LLM:** Grok 4.1 Fast / GPT-5.1 / Gemini 3 Pro (—á–µ—Ä–µ–∑ OpenRouter –∞–±–æ –Ω–∞–ø—Ä—è–º—É).
*   **–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö:** Supabase (PostgreSQL).
*   **–ö–∞—Ç–∞–ª–æ–≥:** ~100 —Ç–æ–≤–∞—Ä—ñ–≤, –≤–±—É–¥–æ–≤–∞–Ω–∏—Ö —É —Å–∏—Å—Ç–µ–º–Ω–∏–π –ø—Ä–æ–º–ø—Ç (Embedded Catalog).

**–ö–ª—é—á–æ–≤–∞ —Ü—ñ–ª—å –±–æ—Ç–∞:** –î–æ–ø–æ–º–æ–≥—Ç–∏ –∫–ª—ñ—î–Ω—Ç—É –æ–±—Ä–∞—Ç–∏ —Ç–æ–≤–∞—Ä, —É—Ç–æ—á–Ω–∏—Ç–∏ —Ä–æ–∑–º—ñ—Ä/–∫–æ–ª—ñ—Ä, —ñ –¥–æ–≤–µ—Å—Ç–∏ –¥–æ –ø–æ–∫—É–ø–∫–∏. –ë–æ—Ç –ù–ï –ø—Ä–æ–¥–∞—î –Ω–∞–ø—Ä—è–º—É, –∞ –ø–µ—Ä–µ–¥–∞—î –∑–∞—è–≤–∫—É –º–µ–Ω–µ–¥–∂–µ—Ä—É.

---

## 1. –§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ñ –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–Ω—ñ –ü—Ä–∏–Ω—Ü–∏–ø–∏

### 1.1. –Ñ–¥–∏–Ω–µ –î–∂–µ—Ä–µ–ª–æ –ü—Ä–∞–≤–¥–∏ (Single Source of Truth - SSOT)
–•–∞–æ—Å –≤–∏–Ω–∏–∫–∞—î —Ç–∞–º, –¥–µ –ª–æ–≥—ñ–∫–∞ –¥—É–±–ª—é—î—Ç—å—Å—è. –£ —Ü—å–æ–º—É –ø—Ä–æ–µ–∫—Ç—ñ –¥—ñ—é—Ç—å —á—ñ—Ç–∫—ñ –ø—Ä–∞–≤–∏–ª–∞:

| –©–æ | –î–µ –≤–∏–∑–Ω–∞—á–µ–Ω–æ | –ó–ê–ë–û–†–û–ù–ï–ù–û |
|----|--------------|------------|
| **–°—Ç–∞–Ω–∏ (States)** | `src/core/state_machine.py` | –í–∏–≥–∞–¥—É–≤–∞—Ç–∏ —Å—Ç–∞–Ω–∏ –≤ –ø—Ä–æ–º–ø—Ç–∞—Ö |
| **–Ü–Ω—Ç–µ–Ω—Ç–∏ (Intents)** | `src/core/state_machine.py` | –î—É–±–ª—é–≤–∞—Ç–∏ –ª–æ–≥—ñ–∫—É –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è —ñ–Ω—Ç–µ–Ω—Ç—ñ–≤ |
| **–ù–∞–∑–≤–∏ —Ç–∞–±–ª–∏—Ü—å –ë–î** | `src/core/constants.py` (–∫–ª–∞—Å `DBTable`) | –•–∞—Ä–¥–∫–æ–¥–∏—Ç–∏ `"mirt_users"` |
| **–¢–µ–≥–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å** | `src/core/constants.py` (–∫–ª–∞—Å `MessageTag`) | –ü–∏—Å–∞—Ç–∏ `"humanNeeded-wd"` –Ω–∞–ø—Ä—è–º—É |
| **–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä—ñ–≤** | `data/system_prompt_full.yaml` (Block 2) | –ó–±–µ—Ä—ñ–≥–∞—Ç–∏ —Ç–æ–≤–∞—Ä–∏ –≤ —ñ–Ω—à–∏—Ö —Ñ–∞–π–ª–∞—Ö |
| **–ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è** | `src/conf/config.py` | –•–∞—Ä–¥–∫–æ–¥–∏—Ç–∏ API –∫–ª—é—á—ñ |

### 1.2. –Ø–≤–Ω–µ –∫—Ä–∞—â–µ, –Ω—ñ–∂ –Ω–µ—è–≤–Ω–µ (Explicit > Implicit)
*   **–¢–∏–ø—ñ–∑–∞—Ü—ñ—è:** –ú–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Å—É—á–∞—Å–Ω–∏–π Python 3.10+.
    *   ‚ùå **BAD:** `def process(data):` (–Ω–µ–∑—Ä–æ–∑—É–º—ñ–ª–æ, —â–æ —Ç–∞–∫–µ data)
    *   ‚ùå **BAD:** `def process(data: Dict[str, Any]):` (—Å—Ç–∞—Ä–∏–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å)
    *   ‚úÖ **GOOD:** `def process(data: dict[str, Any]) -> None:` (—Å—É—á–∞—Å–Ω–∏–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å)
    *   ‚úÖ **BEST:** –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ Pydantic –º–æ–¥–µ–ª—ñ (`ValidatedProduct`, `StoredMessage`).
*   **–ù—ñ—è–∫–æ–≥–æ `Any`:** –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è `Any` –¥–æ–∑–≤–æ–ª–µ–Ω–æ —Ç—ñ–ª—å–∫–∏ —É –≤–∏–Ω—è—Ç–∫–æ–≤–∏—Ö –≤–∏–ø–∞–¥–∫–∞—Ö (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥—É —Å–∏—Ä–æ–≥–æ JSON), —ñ –º–∞—î –±—É—Ç–∏ –ª–æ–∫–∞–ª—ñ–∑–æ–≤–∞–Ω–µ.

### 1.3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç—É (–ù–µ –ø–æ—Ä—É—à—É–≤–∞—Ç–∏!)

```
src/
‚îú‚îÄ‚îÄ core/                 # üß† –ú–æ–∑–æ–∫: FSM, –º–æ–¥–µ–ª—ñ, –≤–∞–ª—ñ–¥–∞—Ü—ñ—è
‚îÇ   ‚îú‚îÄ‚îÄ state_machine.py  # ‚≠ê –ì–û–õ–û–í–ù–ò–ô –§–ê–ô–õ: State, Intent, Transitions
‚îÇ   ‚îú‚îÄ‚îÄ constants.py      # DBTable, MessageTag, —ñ–Ω—à—ñ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∏
‚îÇ   ‚îú‚îÄ‚îÄ models.py         # Pydantic –º–æ–¥–µ–ª—ñ
‚îÇ   ‚îî‚îÄ‚îÄ product_adapter.py # –í–∞–ª—ñ–¥–∞—Ü—ñ—è —Ç–æ–≤–∞—Ä—ñ–≤
‚îú‚îÄ‚îÄ agents/               # ü§ñ LangGraph –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü—ñ—è
‚îÇ   ‚îî‚îÄ‚îÄ graph_v2.py       # 5-–≤—É–∑–ª–æ–≤–∏–π –≥—Ä–∞—Ñ
‚îú‚îÄ‚îÄ services/             # üîß –ë—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ message_store.py  # –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
‚îÇ   ‚îú‚îÄ‚îÄ summarization.py  # –ü–µ—Ä–µ—É–ø–∞–∫–æ–≤–∫–∞ (3 –¥–Ω—ñ)
‚îÇ   ‚îî‚îÄ‚îÄ followups.py      # –§–æ–ª–æ—É–∞–ø–∏
‚îú‚îÄ‚îÄ server/               # üåê FastAPI endpoints
‚îÇ   ‚îî‚îÄ‚îÄ main.py           # –í–µ–±—Ö—É–∫–∏
‚îî‚îÄ‚îÄ conf/                 # ‚öôÔ∏è –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
    ‚îî‚îÄ‚îÄ config.py         # Pydantic Settings

data/
‚îú‚îÄ‚îÄ system_prompt_full.yaml  # ‚≠ê –ì–û–õ–û–í–ù–ò–ô –ü–†–û–ú–ü–¢ + –ö–ê–¢–ê–õ–û–ì
‚îî‚îÄ‚îÄ catalog.json             # –î–ª—è —Ç–µ—Å—Ç—ñ–≤
```

---

## 2. –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏ –ö–æ–¥—É —Ç–∞ –û–±—Ä–æ–±–∫–∞ –ü–æ–º–∏–ª–æ–∫

### 2.1. –ñ–æ—Ä—Å—Ç–∫–µ —Ç–∞–±—É –Ω–∞ –º–æ–≤—á–∞–∑–Ω—ñ –ø–æ–º–∏–ª–∫–∏
–ù–∞–π–≥—ñ—Ä—à–∏–π –≥—Ä—ñ—Ö —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∞ ‚Äî –ø—Ä–∏—Ö–æ–≤–∞—Ç–∏ –ø–æ–º–∏–ª–∫—É.
*   ‚ùå **CRITICAL ERROR:**
    ```python
    try:
        db.insert(...)
    except Exception:
        pass  # ü§¨ –ù–Ü–ö–û–õ–ò –¢–ê–ö –ù–ï –†–û–ë–ò!
    ```
*   ‚úÖ **CORRECT:**
    ```python
    try:
        db.insert(...)
    except Exception as e:
        logger.error("Failed to insert data: %s", e)
        raise  # –ê–±–æ –ø–æ–≤–µ—Ä–Ω–∏ fallback-–∑–Ω–∞—á–µ–Ω–Ω—è, —è–∫—â–æ —Ü–µ –¥–æ–ø—É—Å—Ç–∏–º–æ
    ```

### 2.2. DRY (Don't Repeat Yourself)
–Ø–∫—â–æ –ª–æ–≥—ñ–∫–∞ –ø–æ–≤—Ç–æ—Ä—é—î—Ç—å—Å—è –¥–≤—ñ—á—ñ ‚Äî –≤–∏–Ω–µ—Å–∏ —ó—ó –≤ –ø—Ä–∏–≤–∞—Ç–Ω–∏–π –º–µ—Ç–æ–¥.
*   –ü—Ä–∏–∫–ª–∞–¥: –í–∞–ª—ñ–¥–∞—Ü—ñ—è –ø—Ä–æ–¥—É–∫—Ç—É –≤ `ProductAdapter` –≤–∏–Ω–µ—Å–µ–Ω–∞ –≤ `_create_validated_product`. –ù–µ –∫–æ–ø—ñ–ø–∞—Å—Ç–∏—Ç–∏ –ª–æ–≥—ñ–∫—É!

### 2.3. –í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å "–ú–∞–≥—ñ—á–Ω–∏—Ö –ó–Ω–∞—á–µ–Ω—å" (No Magic Strings)
*   –ù—ñ–∫–æ–ª–∏ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —Ö–∞—Ä–¥–∫–æ–¥-—Ä—è–¥–∫–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å—ñ–≤, —Ç–µ–≥—ñ–≤ —á–∏ –Ω–∞–∑–≤ —Ç–∞–±–ª–∏—Ü—å.
*   ‚ùå `if table == "mirt_users":`
*   ‚úÖ `if table == DBTable.USERS:`

### 2.4. –Ü–º–µ–Ω—É–≤–∞–Ω–Ω—è
*   **–ö–ª–∞—Å–∏:** `PascalCase` (`ValidatedProduct`, `SupabaseMessageStore`)
*   **–§—É–Ω–∫—Ü—ñ—ó/–º–µ—Ç–æ–¥–∏:** `snake_case` (`create_message_store`, `_parse_response`)
*   **–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏:** `UPPER_SNAKE_CASE` (`DEFAULT_MATCH_COUNT`, `MAX_RESPONSE_CHARS`)
*   **–ü—Ä–∏–≤–∞—Ç–Ω—ñ –º–µ—Ç–æ–¥–∏:** –ü–æ—á–∏–Ω–∞—é—Ç—å—Å—è –∑ `_` (`_update_user_interaction`)

---

## 3. –†–æ–±–æ—Ç–∞ –∑ –ë–∞–∑–æ—é –î–∞–Ω–∏—Ö (Supabase)

### 3.1. –ö–æ–Ω—Ç—Ä–∞–∫—Ç –¢–∞–±–ª–∏—Ü—å
–í—Å—ñ –∑–∞–ø–∏—Ç–∏ –¥–æ –ë–î –º–∞—é—Ç—å –π—Ç–∏ **–¢–Ü–õ–¨–ö–ò** —á–µ—Ä–µ–∑ —ñ–º–µ–Ω–æ–≤–∞–Ω—ñ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∏ –∑ `src/core/constants.py`:

| –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ | –¢–∞–±–ª–∏—Ü—è | –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è |
|-----------|---------|-------------|
| `DBTable.USERS` | `mirt_users` | CRM: user_id, summary, last_interaction_at |
| `DBTable.MESSAGES` | `mirt_messages` | –Ü—Å—Ç–æ—Ä—ñ—è —á–∞—Ç—É: role, content, content_type |
| `DBTable.SESSIONS` | `agent_sessions` | –°—Ç–∞–Ω FSM: session_id, state (jsonb) |

### 3.2. CRM Flow (–ù–µ–∑–º—ñ–Ω–Ω–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º)
–¶–µ–π –ø–æ—Ä—è–¥–æ–∫ –¥—ñ–π –Ω–µ –º–æ–∂–Ω–∞ –ø–æ—Ä—É—à—É–≤–∞—Ç–∏:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –í–•–Ü–î–ù–ï –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø (–∫–ª—ñ—î–Ω—Ç –ø–∏—à–µ)                               ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                               ‚îÇ
‚îÇ  1. –ó–±–µ—Ä–µ–≥—Ç–∏ –≤ mirt_messages (user_id, role='user', content)     ‚îÇ
‚îÇ  2. –û–Ω–æ–≤–∏—Ç–∏ mirt_users.last_interaction_at = now()               ‚îÇ
‚îÇ  3. –û–±—Ä–æ–±–∏—Ç–∏ —á–µ—Ä–µ–∑ LangGraph ‚Üí –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –í–Ü–î–ü–û–í–Ü–î–¨ –ë–û–¢–ê                                                  ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                                   ‚îÇ
‚îÇ  1. –ó–±–µ—Ä–µ–≥—Ç–∏ –≤ mirt_messages (user_id, role='assistant')         ‚îÇ
‚îÇ  2. –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∫–ª—ñ—î–Ω—Ç—É —á–µ—Ä–µ–∑ ManyChat/Telegram                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ü–ï–†–ï–£–ü–ê–ö–û–í–ö–ê (—á–µ—Ä–µ–∑ 3 –¥–Ω—ñ –±–µ–∑ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ)                       ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                         ‚îÇ
‚îÇ  1. ManyChat —Å–º–∏–∫–∞—î /automation/mirt-summarize-prod-v1           ‚îÇ
‚îÇ  2. –ë–æ—Ç —á–∏—Ç–∞—î –≤—Å—ñ mirt_messages –¥–ª—è user_id                      ‚îÇ
‚îÇ  3. –ì–µ–Ω–µ—Ä—É—î —Ç–µ–∫—Å—Ç–æ–≤–∏–π summary                                    ‚îÇ
‚îÇ  4. –ó–±–µ—Ä—ñ–≥–∞—î –≤ mirt_users.summary                                ‚îÇ
‚îÇ  5. –í–ò–î–ê–õ–Ø–Ñ —Å—Ç–∞—Ä—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ mirt_messages                   ‚îÇ
‚îÇ  6. –ü–æ–≤–µ—Ä—Ç–∞—î { "action": "remove_tags" } –¥–ª—è ManyChat            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 4. –Ü–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞ –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è

### 4.1. –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
*   –í—Å—ñ –∑–º—ñ–Ω–Ω—ñ –æ—Ç–æ—á–µ–Ω–Ω—è (`.env`) –º–∞—é—Ç—å –±—É—Ç–∏ –æ–ø–∏—Å–∞–Ω—ñ –≤ `src/conf/config.py` (Pydantic `BaseSettings`).
*   –°–µ–∫—Ä–µ—Ç–∏ (–∫–ª—é—á—ñ API) –º–∞—é—Ç—å –±—É—Ç–∏ —Ç–∏–ø—É `SecretStr`, —â–æ–± –≤–∏–ø–∞–¥–∫–æ–≤–æ –Ω–µ –ø–æ—Ç—Ä–∞–ø–∏—Ç–∏ –≤ –ª–æ–≥–∏.
*   Feature Flags –¥–ª—è –ø–æ—Å—Ç—É–ø–æ–≤–æ–≥–æ rollout (`USE_GRAPH_V2`, `ENABLE_OBSERVABILITY`).

### 4.2. Embedded Catalog Mode
–ü—Ä–æ–µ–∫—Ç –ø—Ä–∞—Ü—é—î –≤ —Ä–µ–∂–∏–º—ñ **Embedded Catalog**.
*   **–ó–ê–ë–û–†–û–ù–ï–ù–û** –≤—ñ–¥–Ω–æ–≤–ª—é–≤–∞—Ç–∏ –∫–æ–¥ –¥–ª—è Supabase Vector Store / RAG.
*   –í–µ—Å—å –ø–æ—à—É–∫ –∑–¥—ñ–π—Å–Ω—é—î—Ç—å—Å—è LLM-–º–æ–¥–µ–ª–ª—é –Ω–∞ –æ—Å–Ω–æ–≤—ñ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –∑ `system_prompt_full.yaml`.
*   –Ø–∫—â–æ —Ç–æ–≤–∞—Ä—ñ–≤ —Å—Ç–∞–Ω–µ > 200, –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä—É (–∞–ª–µ –Ω–µ —Ä–∞–Ω—ñ—à–µ!).

---

## 5. –Ø–∫—ñ—Å—Ç—å –ü—Ä–æ–º–ø—Ç—ñ–≤ (Prompt Engineering)

### 5.1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç—É (`data/system_prompt_full.yaml`)

–ü—Ä–æ–º–ø—Ç MIRT AI —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è –∑ –ª–æ–≥—ñ—á–Ω–∏—Ö –±–ª–æ–∫—ñ–≤. **–ü–æ—Ä—è–¥–æ–∫ –±–ª–æ–∫—ñ–≤ –∫—Ä–∏—Ç–∏—á–Ω–∏–π!**

| Block | –ù–∞–∑–≤–∞ | –ó–º—ñ—Å—Ç | –ú–æ–∂–Ω–∞ –∑–º—ñ–Ω—é–≤–∞—Ç–∏? |
|-------|-------|-------|------------------|
| 0 | **Identity** | –•—Ç–æ —Ç–∏ (AI-—Å—Ç–∏–ª—ñ—Å—Ç MIRT) | ‚ùå –¢—ñ–ª—å–∫–∏ –∑ –¥–æ–∑–≤–æ–ª—É |
| 1 | **Rules** | –ñ–æ—Ä—Å—Ç–∫—ñ –ø—Ä–∞–≤–∏–ª–∞ –ø–æ–≤–µ–¥—ñ–Ω–∫–∏ | ‚ùå –¢—ñ–ª—å–∫–∏ –∑ –¥–æ–∑–≤–æ–ª—É |
| 2 | **Catalog** | –¢–æ–≤–∞—Ä–∏ (Embedded) | ‚úÖ –ü—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ –∞—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç—É |
| 3 | **FSM States** | –û–ø–∏—Å —Å—Ç–∞–Ω—ñ–≤ —ñ –ø–µ—Ä–µ—Ö–æ–¥—ñ–≤ | ‚ùå –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ –∑ –∫–æ–¥–æ–º |
| 4 | **Output Contract** | –§–æ—Ä–º–∞—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (JSON) | ‚ùå –ö—Ä–∏—Ç–∏—á–Ω–∏–π –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥—É |
| 5 | **Examples** | Few-shot –ø—Ä–∏–∫–ª–∞–¥–∏ | ‚úÖ –ú–æ–∂–Ω–∞ –ø–æ–∫—Ä–∞—â—É–≤–∞—Ç–∏ |

### 5.2. –ü—Ä–∞–≤–∏–ª–∞ –Ω–∞–ø–∏—Å–∞–Ω–Ω—è –ø—Ä–æ–º–ø—Ç—ñ–≤

1.  **–ú–æ–≤–∞:** –ü—Ä–æ–º–ø—Ç –ø–∏—à–µ—Ç—å—Å—è —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é (–±–æ—Ç —Å–ø—ñ–ª–∫—É—î—Ç—å—Å—è —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é).
2.  **–ß—ñ—Ç–∫—ñ—Å—Ç—å:** –ö–æ–∂–Ω–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è ‚Äî –æ–∫—Ä–µ–º–∏–π –ø—É–Ω–∫—Ç. –ù—ñ—è–∫–∏—Ö "–ø—Ä–æ—Å—Ç–∏—Ä–∞–¥–µ–ª" —Ç–µ–∫—Å—Ç—É.
3.  **–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–∏:** –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π `–ö–†–ò–¢–ò–ß–ù–û:`, `–í–ê–ñ–õ–ò–í–û:`, `–ó–ê–ë–û–†–û–ù–ï–ù–û:` –¥–ª—è –∞–∫—Ü–µ–Ω—Ç—ñ–≤.
4.  **–ü—Ä–∏–∫–ª–∞–¥–∏:** Few-shot –ø—Ä–∏–∫–ª–∞–¥–∏ –û–ë–û–í'–Ø–ó–ö–û–í–Ü –¥–ª—è —Å–∫–ª–∞–¥–Ω–æ—ó –ª–æ–≥—ñ–∫–∏.
5.  **–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è:** –ü—ñ—Å–ª—è –∑–º—ñ–Ω–∏ –ø—Ä–æ–º–ø—Ç—É ‚Äî –∑–∞–ø—É—Å—Ç–∏ `tests/eval/run_eval.py`.

### 5.3. –§–æ—Ä–º–∞—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (OUTPUT_CONTRACT)

–ë–æ—Ç –ó–ê–í–ñ–î–ò –ø–æ–≤–µ—Ä—Ç–∞—î JSON —Ç–∞–∫–æ—ó —Å—Ç—Ä—É–∫—Ç—É—Ä–∏:

```json
{
  "reply_text": "–¢–µ–∫—Å—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –∫–ª—ñ—î–Ω—Ç—É",
  "current_state": "STATE_4_OFFER",
  "detected_intent": "SIZE_HELP",
  "products": [
    {
      "id": 3443041,
      "name": "–°—É–∫–Ω—è –ê–Ω–Ω–∞",
      "size": "122-128",
      "color": "–≥–æ–ª—É–±–∏–π",
      "price": 1850,
      "photo_url": "https://cdn.sitniks.com/..."
    }
  ],
  "needs_human": false,
  "confidence": 0.95
}
```

**–ö–†–ò–¢–ò–ß–ù–Ü –ü–û–õ–Ø:**
*   `reply_text` ‚Äî –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–π, –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ–º.
*   `current_state` ‚Äî –º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ enum `State` –∑ `state_machine.py`.
*   `products` ‚Äî —è–∫—â–æ —î —Ç–æ–≤–∞—Ä–∏, –≤–∞–ª—ñ–¥—É–≤–∞—Ç–∏ —á–µ—Ä–µ–∑ `ProductAdapter`.

### 5.4. –ó–∞–±–æ—Ä–æ–Ω–µ–Ω—ñ –ø–∞—Ç–µ—Ä–Ω–∏ –≤ –ø—Ä–æ–º–ø—Ç–∞—Ö

*   ‚ùå `–¢–∏ –º–æ–∂–µ—à —Ä–æ–±–∏—Ç–∏ –≤—Å–µ` ‚Äî –Ω–∞–¥—Ç–æ —à–∏—Ä–æ–∫–æ, LLM –ø—ñ–¥–µ –Ω–µ —Ç—É–¥–∏.
*   ‚ùå `–ë—É–¥—å –∫–æ—Ä–∏—Å–Ω–∏–º` ‚Äî –Ω–µ–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ.
*   ‚ùå –°—É–ø–µ—Ä–µ—á–ª–∏–≤—ñ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó (—Ç–∏–ø—É "–±—É–¥—å –∫–æ—Ä–æ—Ç–∫–∏–º, –∞–ª–µ –¥–µ—Ç–∞–ª—å–Ω–∏–º").
*   ‚ùå –î–æ–≤–≥—ñ –∞–±–∑–∞—Ü–∏ –±–µ–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏.
*   ‚ùå –ó–∞–π–≤–∞ "–≤–≤—ñ—á–ª–∏–≤—ñ—Å—Ç—å" (`–ë—É–¥—å –ª–∞—Å–∫–∞, —è–∫—â–æ –Ω–µ –≤–∞–∂–∫–æ...`).

### 5.5. –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω—ñ –ø–∞—Ç–µ—Ä–Ω–∏

*   ‚úÖ `–ó–ê–ë–û–†–û–ù–ï–ù–û: –æ–±–≥–æ–≤–æ—Ä—é–≤–∞—Ç–∏ —Ü—ñ–Ω–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ñ–≤.`
*   ‚úÖ `–Ø–∫—â–æ –∫–ª—ñ—î–Ω—Ç –ø–∏—Ç–∞—î –ø—Ä–æ [X], –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–π [Y].`
*   ‚úÖ `–ü—Ä–∏–∫–ª–∞–¥: –ö–ª—ñ—î–Ω—Ç: "..." ‚Üí –ë–æ—Ç: "..."`
*   ‚úÖ –ß—ñ—Ç–∫—ñ if/then –ø—Ä–∞–≤–∏–ª–∞.
*   ‚úÖ Numbered lists –¥–ª—è –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–∏—Ö –¥—ñ–π.

---

## 6. –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### 6.1. –ü—Ä–∞–≤–∏–ª–∞ —Ç–µ—Å—Ç—ñ–≤
*   **–ù—ñ—è–∫–∏—Ö –∑–æ–≤–Ω—ñ—à–Ω—ñ—Ö –≤–∏–∫–ª–∏–∫—ñ–≤:** –¢–µ—Å—Ç–∏ –ù–ï —Å–º–∏–∫–∞—é—Ç—å Supabase, LLM, ManyChat.
*   **–ú–æ–∫–∏:** –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π `AsyncMock` –¥–ª—è LLM, `InMemoryMessageStore` –¥–ª—è –ë–î.
*   **–§—ñ–∫—Å—Ç—É—Ä–∏:** –ö–∞—Ç–∞–ª–æ–≥ –¥–ª—è —Ç–µ—Å—Ç—ñ–≤ ‚Äî `data/catalog.json`.
*   **Golden Dataset:** –ï—Ç–∞–ª–æ–Ω–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤ `tests/eval/datasets/`.

### 6.2. –©–æ —Ç–µ—Å—Ç—É–≤–∞—Ç–∏
*   ‚úÖ FSM transitions (`test_state_machine.py`)
*   ‚úÖ Product validation (`test_product_adapter.py`)
*   ‚úÖ ManyChat webhook parsing (`test_manychat.py`)
*   ‚úÖ Summarization logic (`test_summarization.py`)

---

## 7. ManyChat / Telegram –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è

### 7.1. Endpoints

| Endpoint | –ú–µ—Ç–æ–¥ | –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è |
|----------|-------|-------------|
| `/webhooks/manychat` | POST | –û—Å–Ω–æ–≤–Ω–∏–π —á–∞—Ç |
| `/webhooks/manychat/followup` | POST | –§–æ–ª–æ—É–∞–ø–∏ (4 –≥–æ–¥) |
| `/webhooks/manychat/create-order` | POST | –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤ CRM |
| `/automation/mirt-summarize-prod-v1` | POST | –ü–µ—Ä–µ—É–ø–∞–∫–æ–≤–∫–∞ (3 –¥–Ω—ñ) |
| `/webhooks/telegram` | POST | Telegram –±–æ—Ç |

### 7.2. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è
*   Header `X-Manychat-Token` = `MANYCHAT_VERIFY_TOKEN` –∑ `.env`.
*   –Ø–∫—â–æ —Ç–æ–∫–µ–Ω –Ω–µ–≤—ñ—Ä–Ω–∏–π ‚Äî –ø–æ–≤–µ—Ä—Ç–∞–π 401.

---

## 8. –ß–µ–∫-–ª—ñ—Å—Ç –ø–µ—Ä–µ–¥ –∫–æ–º—ñ—Ç–æ–º (–¥–ª—è AI)

–ö–æ–∂–µ–Ω —Ä–∞–∑, –∫–æ–ª–∏ —Ç–∏ –∑–º—ñ–Ω—é—î—à –∫–æ–¥, –ø–µ—Ä–µ–≤—ñ—Ä —Å–µ–±–µ:

| # | –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ | –©–æ —Ä–æ–±–∏—Ç–∏, —è–∫—â–æ –Ω—ñ |
|---|-----------|-------------------|
| 1 | –ß–∏ –Ω–µ –¥–æ–¥–∞–≤ —è "–º–∞–≥—ñ—á–Ω–∏—Ö —Å—Ç—Ä–æ–∫"? | –í–∏–Ω–µ—Å–∏ –≤ `constants.py` |
| 2 | –ß–∏ –Ω–µ –∑–ª–∞–º–∞–≤ —è —Ç–∏–ø—ñ–∑–∞—Ü—ñ—é? | –ó–∞–ø—É—Å—Ç–∏ `mypy src` |
| 3 | –ß–∏ –æ–±—Ä–æ–±–ª–µ–Ω—ñ –ø–æ–º–∏–ª–∫–∏? | –î–æ–¥–∞–π `logger.error()` |
| 4 | –ß–∏ —î —Ç–µ—Å—Ç –Ω–∞ –Ω–æ–≤—É –ª–æ–≥—ñ–∫—É? | –ù–∞–ø–∏—à–∏ —Ç–µ—Å—Ç |
| 5 | –ß–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–∏–π –ø—Ä–æ–º–ø—Ç –∑ –∫–æ–¥–æ–º? | –ü–µ—Ä–µ–≤—ñ—Ä States/Intents |
| 6 | –ß–∏ –ø—Ä–æ–π—à–ª–∏ —Ç–µ—Å—Ç–∏? | –ó–∞–ø—É—Å—Ç–∏ `pytest` |

---

## 9. –ó–∞–±–æ—Ä–æ–Ω–µ–Ω—ñ –¥—ñ—ó (Hard Rules)

| # | –ó–ê–ë–û–†–û–ù–ï–ù–û | –ß–æ–º—É |
|---|------------|------|
| 1 | –í–∏–¥–∞–ª—è—Ç–∏ –∞–±–æ –∫–æ–º–µ–Ω—Ç—É–≤–∞—Ç–∏ —Ç–µ—Å—Ç–∏ | –ú–∞—Å–∫—É—î –±–∞–≥–∏ |
| 2 | –í—ñ–¥–Ω–æ–≤–ª—é–≤–∞—Ç–∏ RAG/Vector Search | –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–Ω–µ —Ä—ñ—à–µ–Ω–Ω—è |
| 3 | –•–∞—Ä–¥–∫–æ–¥–∏—Ç–∏ —Å–µ–∫—Ä–µ—Ç–∏ | –ë–µ–∑–ø–µ–∫–∞ |
| 4 | –ü–∏—Å–∞—Ç–∏ `except: pass` | –•–æ–≤–∞—î –ø–æ–º–∏–ª–∫–∏ |
| 5 | –î—É–±–ª—é–≤–∞—Ç–∏ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è States/Intents | SSOT violation |
| 6 | –ó–º—ñ–Ω—é–≤–∞—Ç–∏ OUTPUT_CONTRACT –±–µ–∑ —É–∑–≥–æ–¥–∂–µ–Ω–Ω—è | –ó–ª–∞–º–∞—î –ø–∞—Ä—Å–∏–Ω–≥ |
| 7 | –í–∏–¥–∞–ª—è—Ç–∏ –ª–æ–≥—É–≤–∞–Ω–Ω—è | –ù–µ–º–æ–∂–ª–∏–≤–æ –¥–µ–±–∞–∂–∏—Ç–∏ |

---

> **–§–Ü–ù–ê–õ–¨–ù–ï –°–õ–û–í–û:**
> –ü–∏—à–∏ –∫–æ–¥ —Ç–∞–∫, –Ω—ñ–±–∏ –π–æ–≥–æ –±—É–¥–µ –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –º–∞–Ω—ñ—è–∫, —è–∫–∏–π –∑–Ω–∞—î, –¥–µ —Ç–≤—ñ–π —Å–µ—Ä–≤–µ—Ä.
> –†–æ–±–∏ –Ω–∞–¥—ñ–π–Ω–æ. –†–æ–±–∏ —è–≤–Ω–æ. –†–æ–±–∏ –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–æ.
> 
> **–Ø–∫—â–æ —Å—É–º–Ω—ñ–≤–∞—î—à—Å—è ‚Äî –∑–∞–ø–∏—Ç–∞–π. –Ø–∫—â–æ –Ω–µ –∑–Ω–∞—î—à ‚Äî –Ω–µ –≤–∏–≥–∞–¥—É–π.**
