# üëÅÔ∏è Vision Layer (–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏)

**–®–ª—è—Ö:** `src/agents/langgraph/nodes/vision/`

## üìñ –©–æ —Ü–µ —Ç–∞–∫–µ?
Vision Layer - —Ü–µ "–æ—á—ñ" –Ω–∞—à–æ—ó —Å–∏—Å—Ç–µ–º–∏. –¶–µ–π –º–æ–¥—É–ª—å –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∑–∞ –æ–±—Ä–æ–±–∫—É —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ–π –≤—ñ–¥ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é —Ç–æ–≤–∞—Ä—É –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö —Ç–∞ —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –∫—Ä–∞—Å–∏–≤–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ-–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—ó.

–†–∞–Ω—ñ—à–µ —Ü–µ –±—É–≤ –æ–¥–∏–Ω —Ñ–∞–π–ª-–º–æ–Ω—Å—Ç—Ä –Ω–∞ 1000+ —Ä—è–¥–∫—ñ–≤. –¢–µ–ø–µ—Ä —Ü–µ **–º–æ–¥—É–ª—å–Ω–∏–π –ø–∞–∫–µ—Ç**, —è–∫–∏–π –ª–µ–≥–∫–æ –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞—Ç–∏ —Ç–∞ —Ä–æ–∑—à–∏—Ä—é–≤–∞—Ç–∏.

---

## üèóÔ∏è –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ (–Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î)

–ú–∏ –∑–∞—Å—Ç–æ—Å—É–≤–∞–ª–∏ –ø–∞—Ç–µ—Ä–Ω **Pipeline (–ö–æ–Ω–≤–µ—î—Ä)**. –î–∞–Ω—ñ —Ç–µ—á—É—Ç—å —á–µ—Ä–µ–∑ 4 —Å—Ç–∞–¥—ñ—ó:

1.  **Orchestrator (`node.py`)**: –û—Ç—Ä–∏–º—É—î `State` (–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, URL —Ñ–æ—Ç–æ) —ñ –∫–µ—Ä—É—î –ø—Ä–æ—Ü–µ—Å–æ–º.
2.  **Vision Agent (AI)**: –ê–Ω–∞–ª—ñ–∑—É—î —Ñ–æ—Ç–æ, –≤–∏–∑–Ω–∞—á–∞—î —Ç–∏–ø –æ–¥—è–≥—É, –∫–æ–ª—ñ—Ä —Ç–∞ –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ.
3.  **Enricher (DB)**: –®—É–∫–∞—î *—Ä–µ–∞–ª—å–Ω–∏–π* —Ç–æ–≤–∞—Ä —É –±–∞–∑—ñ –¥–∞–Ω–∏—Ö (CRM/Catalog), —è–∫–∏–π –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –æ–ø–∏—Å—É AI.
4.  **Builder (UI)**: –§–æ—Ä–º—É—î –∫—ñ–Ω—Ü–µ–≤—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (—Ç–µ–∫—Å—Ç–æ–≤—ñ "–±–∞–±–ª–∏", —Ñ–æ—Ç–æ, —Ü—ñ–Ω–∏).

### üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ü–∞–∫–µ—Ç—É

| –§–∞–π–ª | –†–æ–ª—å | –û–ø–∏—Å –¥–ª—è –†–æ–∑—Ä–æ–±–Ω–∏–∫–∞ |
|------|------|--------------------|
| **`node.py`** | üß† **–ú–æ–∑–æ–∫** | –ì–æ–ª–æ–≤–Ω–∞ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥—É. –í–∏–∫–ª–∏–∫–∞—î –∞–≥–µ–Ω—Ç—ñ–≤, –æ–±—Ä–æ–±–ª—è—î –ø–æ–º–∏–ª–∫–∏, —à–ª–µ –Ω–æ—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –ø—Ä–æ –µ—Å–∫–∞–ª–∞—Ü—ñ—é. |
| **`enricher.py`** | üì¶ **–°–∫–ª–∞–¥** | –ß–∏—Å—Ç–∞ –ª–æ–≥—ñ–∫–∞ —Ä–æ–±–æ—Ç–∏ –∑ –ë–î. Fuzzy-–ø–æ—à—É–∫, —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –∑–∞ –∫–æ–ª—å–æ—Ä–æ–º, –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ü—ñ–Ω. |
| **`builder.py`** | üé® **–•—É–¥–æ–∂–Ω–∏–∫** | –í—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∑–∞ —Ç–µ, *—è–∫* –≤–∏–≥–ª—è–¥–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥—å. –ü–æ—Ä—è–¥–æ–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å, —Ç–µ–∫—Å—Ç–∏, –µ–º–æ–¥–∑—ñ. |
| **`snippets.py`** | üìù **–ö–æ–ø—ñ—Ä–∞–π—Ç–µ—Ä** | –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î –≥–æ—Ç–æ–≤—ñ —Ç–µ–∫—Å—Ç–∏ –∑ `snippets.md` (—â–æ–± –Ω–µ —Ö–∞—Ä–¥–∫–æ–¥–∏—Ç–∏ —ó—Ö —É –∫–æ–¥—ñ). |
| **`__init__.py`** | üö™ **–§–∞—Å–∞–¥** | –ï–∫—Å–ø–æ—Ä—Ç—É—î —Ñ—É–Ω–∫—Ü—ñ—é `vision_node`, —â–æ–± —Ä–µ—à—Ç–∞ —Å–∏—Å—Ç–µ–º–∏ –Ω–µ –∑–Ω–∞–ª–∞ –ø—Ä–æ –≤–Ω—É—Ç—Ä—è–Ω–∫—É. |

---

## üõ†Ô∏è –Ø–∫ —Ä–æ–∑—à–∏—Ä—é–≤–∞—Ç–∏ (–ì–∞–π–¥)

### –°—Ü–µ–Ω–∞—Ä—ñ–π 1: "–•–æ—á—É –∑–º—ñ–Ω–∏—Ç–∏ —Ç–µ–∫—Å—Ç –ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è"
**–î–µ –ø—Ä–∞–≤–∏—Ç–∏:** `src/data/prompts/en/snippets.md`
–í–∞–º –Ω–∞–≤—ñ—Ç—å –Ω–µ —Ç—Ä–µ–±–∞ –ª—ñ–∑—Ç–∏ –≤ Python –∫–æ–¥! –ó–º—ñ–Ω—ñ—Ç—å —Ç–µ–∫—Å—Ç –ø—ñ–¥ —Ö–µ–¥–µ—Ä–æ–º `### –ü—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è`.

### –°—Ü–µ–Ω–∞—Ä—ñ–π 2: "–•–æ—á—É, —â–æ–± –ø–æ–∫–∞–∑—É–≤–∞–ª–æ —Ü—ñ–Ω—É –û–î–†–ê–ó–£, –Ω–∞–≤—ñ—Ç—å –±–µ–∑ —Ñ–æ—Ç–æ"
**–î–µ –ø—Ä–∞–≤–∏—Ç–∏:** `src/agents/langgraph/nodes/vision/builder.py`
–ó–Ω–∞–π–¥—ñ—Ç—å —Ñ—É–Ω–∫—Ü—ñ—é `build_vision_messages`.
–õ–æ–≥—ñ–∫–∞ –ø–æ–∫–∞–∑—É —Ü—ñ–Ω–∏ –∑–∞—Ä–∞–∑: `if height: ...`. –ó–º—ñ–Ω—ñ—Ç—å —Ü—é —É–º–æ–≤—É.

### –°—Ü–µ–Ω–∞—Ä—ñ–π 3: "–¢—Ä–µ–±–∞ —à—É–∫–∞—Ç–∏ —Ç–æ–≤–∞—Ä —â–µ –π –∑–∞ –ê—Ä—Ç–∏–∫—É–ª–æ–º (SKU)"
**–î–µ –ø—Ä–∞–≤–∏—Ç–∏:** `src/agents/langgraph/nodes/vision/enricher.py`
1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ `_enrich_product_from_db`.
2. –î–æ–¥–∞–π—Ç–µ –ª–æ–≥—ñ–∫—É: `if is_sku(product_name): search_by_sku(...)`.

### –°—Ü–µ–Ω–∞—Ä—ñ–π 4: "–î–æ–¥–∞—î–º–æ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –±—Ä–µ–Ω–¥—É (Logo)"
–¶–µ –∑–º—ñ–Ω–∞ –≤—Å—å–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω—É:
1.  **AI**: –û–Ω–æ–≤—ñ—Ç—å –ø—Ä–æ–º–ø—Ç –≤ `vision_agent.py` ("Extract brand logo").
2.  **Model**: –î–æ–¥–∞–π—Ç–µ –ø–æ–ª–µ `brand` –≤ `VisionResponse`.
3.  **Enricher**: –î–æ–¥–∞–π—Ç–µ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—é –∑–∞ –±—Ä–µ–Ω–¥–æ–º –≤ `enricher.py`.
4.  **Builder**: –î–æ–¥–∞–π—Ç–µ: `if brand: messages.append(f"–¶–µ –±—Ä–µ–Ω–¥ {brand}")`.

---

## ‚ùì –ü—Ä–æ –ø–∞–ø–∫—É `data/vision`
–ü–∞–ø–∫–∞ `data/vision` (—è–∫—â–æ –≤–æ–Ω–∞ —î —É –ø—Ä–æ–µ–∫—Ç—ñ) –∑–∞–∑–≤–∏—á–∞–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è:
1.  **–ö–µ—à—É**: –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–∏–º—á–∞—Å–æ–≤–∏—Ö —Ñ–∞–π–ª—ñ–≤ –∑–æ–±—Ä–∞–∂–µ–Ω—å –ø–µ—Ä–µ–¥ –≤—ñ–¥–ø—Ä–∞–≤–∫–æ—é.
2.  **–î–µ–±–∞–≥—É**: –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ª–æ–≥—ñ–≤ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è ("—â–æ –±–∞—á–∏—Ç—å –±–æ—Ç").
**–í–∞–∂–ª–∏–≤–æ:** –¶—è –ø–∞–ø–∫–∞ –ù–ï –º—ñ—Å—Ç–∏—Ç—å –ª–æ–≥—ñ–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–∏. –õ–æ–≥—ñ–∫–∞ ‚Äî —Ç—ñ–ª—å–∫–∏ –≤ `src`.

---

## ‚ö†Ô∏è –ï—Å–∫–∞–ª–∞—Ü—ñ—è —Ç–∞ –ü–æ–º–∏–ª–∫–∏
–°–∏—Å—Ç–µ–º–∞ –º–∞—î 3 —Ä—ñ–≤–Ω—ñ –∑–∞—Ö–∏—Å—Ç—É:
1.  **Clarification**: AI –Ω–µ –≤–ø–µ–≤–Ω–µ–Ω–∏–π -> –ø–∏—Ç–∞—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.
2.  **Soft Fallback**: AI –≤–ø–µ–≤–Ω–µ–Ω–∏–π, –∞–ª–µ —Ç–æ–≤–∞—Ä—É –Ω–µ–º–∞—î –≤ –ë–î -> –ø–æ–∫–∞–∑—É—î "—Å—Ö–æ–∂—ñ".
3.  **Hard Escalation**: –ü–æ–º–∏–ª–∫–∞ –∫–æ–¥—É –∞–±–æ API -> —à–ª–µ –∞–ª–µ—Ä—Ç –º–µ–Ω–µ–¥–∂–µ—Ä—É –≤ Telegram (`node.py`) + –≤–∏–±–∞—á–∞—î—Ç—å—Å—è –ø–µ—Ä–µ–¥ –∫–ª—ñ—î–Ω—Ç–æ–º.
